<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TopoLogic: Pro Full & Enhanced</title>
    <style>
        :root { --neon: #0ff; --danger: #f00; --gold: #ff0; }
        body { margin: 0; background: #000; color: #0f0; font-family: 'Segoe UI', system-ui, sans-serif; overflow: hidden; touch-action: none; user-select: none; }
        
        /* HUD - GÃ¶sterge Paneli */
        #ui { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 95%; max-width: 600px; pointer-events: none; z-index: 100; display: none; }
        .panel { background: rgba(5,5,5,0.95); border: 2px solid var(--neon); padding: 15px; border-radius: 18px; box-shadow: 0 0 30px rgba(0,255,255,0.4); text-align: center; }
        .bar-bg { background: #111; height: 16px; border-radius: 8px; margin: 12px 0; border: 1px solid #333; overflow: hidden; }
        #bar-fill { background: linear-gradient(90deg, #008888, var(--neon)); height: 100%; width: 0%; transition: width 0.3s; }
        
        /* Puan GÃ¶stergeleri */
        #top-left-ui { position: absolute; top: 15px; left: 15px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        .info-btn { width: 50px; height: 50px; border-radius: 50%; background: var(--neon); color: #000; border: none; font-weight: bold; font-size: 26px; cursor: pointer; box-shadow: 0 0 20px var(--neon); display: flex; align-items: center; justify-content: center; }
        .total-score-box { background: rgba(0,255,255,0.2); border: 2px solid var(--neon); padding: 10px 18px; border-radius: 25px; color: var(--neon); font-family: 'Courier New', monospace; font-size: 16px; font-weight: 900; backdrop-filter: blur(10px); }

        /* Dinamik Puan Etiketleri (Floating Scores) */
        .score-float { 
            position: absolute; 
            color: #0f0; 
            font-weight: 900; 
            font-size: 36px; 
            pointer-events: none; 
            z-index: 10000; 
            text-shadow: 0 0 15px rgba(0,0,0,1), 0 0 10px currentColor; 
            animation: floatUpAnim 1s ease-out forwards;
        }
        .score-float.neg { color: var(--danger); }
        @keyframes floatUpAnim { 
            0% { transform: translate(-50%, 0) scale(0.4); opacity: 0; } 
            20% { transform: translate(-50%, -20px) scale(1.3); opacity: 1; }
            100% { transform: translate(-50%, -120px) scale(1); opacity: 0; } 
        }

        /* MenÃ¼ ve Modallar */
        #main-menu { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, #1a1a1a 0%, #000 100%); z-index: 3000; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; padding: 40px 20px; box-sizing: border-box; }
        .level-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 15px; width: 100%; max-width: 900px; }
        .level-card { background: rgba(40,40,40,0.9); border: 2px solid #555; border-radius: 15px; padding: 20px; cursor: pointer; transition: 0.3s; text-align: center; color: #fff; }
        .level-card:not(.locked):hover { border-color: var(--neon); box-shadow: 0 0 25px var(--neon); transform: translateY(-5px); }
        .level-card.locked { opacity: 0.3; filter: grayscale(1); cursor: not-allowed; }

        #help-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 6000; display: none; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .modal-content { background: #0a0a0a; border: 2px solid var(--neon); padding: 30px; border-radius: 20px; max-width: 600px; width: 100%; color: #fff; position: relative; box-shadow: 0 0 50px rgba(0,255,255,0.3); }
        
        /* Butonlar ve Durumlar */
        button { background: var(--neon); color: #000; border: none; padding: 18px 35px; font-weight: 900; border-radius: 12px; font-size: 1.1rem; cursor: pointer; transition: 0.3s; }
        #collision-lock, #win-screen, #fail-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5000; display: none; flex-direction: column; justify-content: center; align-items: center; background: rgba(0,0,0,0.92); backdrop-filter: blur(10px); }
    </style>
</head>
<body>

    <div id="top-left-ui">
        <button class="info-btn" onclick="openHelp()">?</button>
        <div class="total-score-box">TOPLAM: <span id="total-score-val">0</span></div>
    </div>

    <!-- YardÄ±m ModÃ¼lÃ¼ -->
    <div id="help-modal">
        <div class="modal-content" id="help-body"></div>
    </div>

    <div id="main-menu">
        <h1 style="color: var(--neon); font-size: clamp(2.5rem, 10vw, 4rem); margin-bottom: 30px; letter-spacing: 6px; text-shadow: 0 0 20px var(--neon);">TOPOLOGIC</h1>
        <div id="level-grid" class="level-grid"></div>
    </div>

    <!-- Hata EkranÄ± -->
    <div id="collision-lock">
        <div style="background:#000; border:4px solid var(--danger); padding:40px; border-radius:25px; text-align:center; box-shadow: 0 0 100px var(--danger);">
            <h2 style="color:var(--danger); font-size: 2.5rem; margin-top:0;">ðŸ›‘ FÄ°ZÄ°K Ã‡AKIÅžTI</h2>
            <p style="color:#fff; font-size: 1.2rem; margin-bottom: 30px;">Kablo kendi Ã¼zerinden geÃ§emez!</p>
            <button id="undo-btn" style="width:100%; background: var(--danger); color:#fff;">GÃœVENLÄ° KONUMA DÃ–N</button>
        </div>
    </div>

    <!-- HUD Panel -->
    <div id="ui" class="panel">
        <div id="timer-display" style="font-size: 2.5rem; color: var(--danger); font-family: monospace; font-weight: 900;">00:00</div>
        <div id="level-info" style="color: var(--neon); font-weight: 900; letter-spacing: 3px; font-size: 1.2rem; margin-top: 5px;">STAGE...</div>
        <div class="bar-bg"><div id="bar-fill"></div></div>
        <div style="display: flex; justify-content: space-around; font-size: 18px; color: var(--neon); font-family: monospace; font-weight: 900;">
            <div>SKOR: <span id="score-val">0</span></div>
            <div>UYUM: %<span id="percent-val">0</span></div>
        </div>
    </div>

    <div id="win-screen">
        <h1 style="color:var(--neon); font-size: 4.5rem; text-shadow: 0 0 30px var(--neon);">KUSURSUZ!</h1>
        <div id="win-score-info" style="color:var(--gold); font-size: 2rem; font-weight: 900; margin-bottom: 40px;"></div>
        <button id="win-next-btn">SIRADAKÄ° FORM</button>
    </div>

    <div id="fail-screen">
        <h1 style="color:var(--danger); font-size: 3.5rem;">ZAMAN BÄ°TTÄ°!</h1>
        <p id="extra-rights-text" style="color: #fff; font-size: 1.5rem; margin-bottom: 30px;"></p>
        <button id="btn-extra" style="background:var(--gold); color:#000; width: 250px;">EK SÃœRE AL</button>
        <button onclick="location.reload()" style="background:#444; color:#fff; width: 250px; margin-top: 15px;">ANA MENÃœ</button>
    </div>

    <script type="importmap">
        { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js", "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/" } }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { DragControls } from 'three/addons/controls/DragControls.js';

        // --- SES VE CÄ°HAZ ---
        const sfx = {
            snap: new Audio('snap.mp3'), collision: new Audio('collision.mp3'),
            undo: new Audio('undo.mp3'), win: new Audio('win.mp3'),
            fail: new Audio('fail.mp3'), bgm: new Audio('bgm.mp3')
        };
        sfx.bgm.loop = true; sfx.bgm.volume = 0.25;

        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        // --- DEÄžÄ°ÅžKENLER ---
        let scene, camera, renderer, controls, dragControls;
        let knotMesh, ghostMesh, knotCurve, handles = [];
        let targetPathPoints = [], currentLevelIndex = 0;
        let unlockedLevel = parseInt(localStorage.getItem('topoMaxLevel')) || 0;
        let totalAccumulatedScore = parseInt(localStorage.getItem('topoTotalScore')) || 0;
        
        let lastSafePositions = [], isLocked = false, collisionCooldown = false;
        let levelTimerActive = false, startTime, levelTimeLimit, gameScore = 0;
        let bonusAwarded = false, extraTimeAttempts = 0;

        const pointValues = [100, 50, 25, 12];
        const levels = [
            { id: "1", name: "Daire (Loop)", type: 'circle', nodes: 8, radius: 8, time: 50 },
            { id: "2", name: "Kalp (Heart)", type: 'heart', nodes: 12, radius: 0.6, time: 70 },
            { id: "3", name: "YÄ±ldÄ±z (Star)", type: 'star', nodes: 14, radius: 8, time: 90 },
            { id: "4", name: "Yonca (Trefoil)", type: 'torus', nodes: 18, p: 2, q: 3, radius: 7, time: 120 },
            { id: "5", name: "BeÅŸyaprak", type: 'torus', nodes: 22, p: 2, q: 5, radius: 7, time: 150 },
            { id: "6", name: "Sekizli (Figure-8)", type: 'figure8', nodes: 26, radius: 8, time: 180 },
            { id: "7", name: "DÃ¼ÄŸÃ¼mlÃ¼ Torus", type: 'torus', nodes: 28, p: 3, q: 7, radius: 8, time: 210 },
            { id: "8", name: "Septifolium", type: 'sept', nodes: 32, radius: 8, time: 240 }
        ];

        // --- YARDIM MENÃœSÃœ ---
        window.openHelp = () => {
            const body = document.getElementById('help-body');
            const closeBtn = `<span class="close-modal" onclick="document.getElementById('help-modal').style.display='none'">Ã—</span>`;
            if (isMobile) {
                body.innerHTML = `${closeBtn}
                    <h2 style="color:var(--neon)">MOBÄ°L KONTROLLER</h2>
                    <p>ðŸ‘‰ <b>DÃ¼ÄŸÃ¼mleri Tut:</b> Parlayan kÄ±rmÄ±zÄ± noktalara basÄ±p sÃ¼rÃ¼kleyin.</p>
                    <p>ðŸ”„ <b>Kamera:</b> BoÅŸ alanda parmaÄŸÄ±nÄ±zÄ± kaydÄ±rarak dÃ¼nyayÄ± dÃ¶ndÃ¼rÃ¼n.</p>
                    <p>ðŸ›‘ <b>Kilitlenme:</b> Kablolar Ã§akÄ±ÅŸÄ±rsa fizik durur. "Geri Al" butonunu kullanÄ±n.</p>
                    <p>ðŸ’° <b>Puan:</b> HÄ±zlÄ± olun ve hattan ayrÄ±lmamaya Ã§alÄ±ÅŸÄ±n!</p>`;
            } else {
                body.innerHTML = `${closeBtn}
                    <h2 style="color:var(--neon)">MASAÃœSTÃœ MASTER REHBER</h2>
                    <p><b>Sol TÄ±k:</b> KÄ±rmÄ±zÄ± dÃ¼ÄŸÃ¼mleri yÃ¶rÃ¼ngeye taÅŸÄ±r.</p>
                    <p><b>SaÄŸ TÄ±k / Tekerlek:</b> KamerayÄ± dÃ¶ndÃ¼rÃ¼r ve zoom yapar.</p>
                    <hr border="0.5">
                    <p><b>Tam Puanlama:</b><br>
                    â€¢ Her baÅŸarÄ±lÄ± 'Snap': <b>+100 / 50 / 25 / 12</b> Puan<br>
                    â€¢ Hattan her ayrÄ±lma: <b>-100 Puan</b><br>
                    â€¢ Kusursuz Uyum Bonusu: <b>+500 Puan</b></p>
                    <p><i>Ä°pucu: Kablo Ã§akÄ±ÅŸmalarÄ±nÄ± Ã¶nlemek iÃ§in dÃ¼ÄŸÃ¼mleri geniÅŸ aÃ§Ä±yla taÅŸÄ±yÄ±n.</i></p>`;
            }
            document.getElementById('help-modal').style.display = 'flex';
        };

        // --- SKOR EFEKTÄ° ---
        function showScoreEffect(pos, val, isNeg) {
            const vector = pos.clone().project(camera);
            const div = document.createElement('div');
            div.className = 'score-float' + (isNeg ? ' neg' : '');
            div.style.left = (vector.x * 0.5 + 0.5) * window.innerWidth + 'px';
            div.style.top = (vector.y * -0.5 + 0.5) * window.innerHeight + 'px';
            div.innerText = (isNeg ? '' : '+') + val;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 1000);
        }

        // --- FÄ°ZÄ°K KONTROLÃœ ---
        function checkCollision() {
            if (collisionCooldown || !knotCurve) return false;
            const pts = knotCurve.getPoints(250); 
            const minSafeDistance = 0.9; 
            for(let i=0; i < pts.length; i++) {
                for(let j=i + 50; j < pts.length; j++) {
                    if (i < 20 && j > pts.length - 20) continue;
                    if (pts[i].distanceTo(pts[j]) < minSafeDistance) return true;
                }
            }
            return false;
        }

        function setupDragControls() {
            if (dragControls) dragControls.dispose();
            dragControls = new DragControls(handles, camera, renderer.domElement);
            
            dragControls.addEventListener('dragstart', (e) => { 
                controls.enabled = false;
                e.object.userData.light.intensity = 50; // ParlaklÄ±ÄŸÄ± artÄ±r
                if(!isLocked) lastSafePositions = handles.map(h => h.position.clone());
            });
            
            dragControls.addEventListener('drag', (e) => {
                if(isLocked) return;
                knotCurve.points = handles.map(h => h.position);
                
                if (checkCollision()) {
                    isLocked = true;
                    sfx.collision.play().catch(()=>{});
                    document.getElementById('collision-lock').style.display = 'flex';
                    dragControls.enabled = false;
                    return;
                }

                const node = e.object;
                const closest = getClosestPointOnPath(node.position);
                const wasOnRail = node.userData.onRail;

                if (!wasOnRail && closest.dist < 1.4) {
                    node.userData.onRail = true;
                    sfx.snap.play().catch(()=>{});
                    const gain = pointValues[Math.min(extraTimeAttempts, 3)];
                    gameScore += gain;
                    showScoreEffect(node.position, gain, false);
                    node.position.copy(closest.pos);
                } else if (wasOnRail && closest.dist > 2.2) {
                    node.userData.onRail = false;
                    gameScore = Math.max(0, gameScore - 100);
                    showScoreEffect(node.position, -100, true);
                }

                if (node.userData.onRail) node.position.copy(closest.pos);
                updateVisuals();
                document.getElementById('score-val').innerText = gameScore;
            });

            dragControls.addEventListener('dragend', (e) => { 
                controls.enabled = true; 
                e.object.userData.light.intensity = 15; // Normal parlaklÄ±ÄŸa dÃ¶n
                checkVictory();
            });
        }

        function loadLevel(idx) {
            sfx.bgm.play().catch(() => {});
            currentLevelIndex = idx;
            const level = levels[idx];
            
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('win-screen').style.display = 'none';
            document.getElementById('fail-screen').style.display = 'none';
            document.getElementById('collision-lock').style.display = 'none';
            document.getElementById('ui').style.display = 'block';
            document.getElementById('level-info').innerText = level.name;
            
            isLocked = false; bonusAwarded = false; extraTimeAttempts = 0; gameScore = 0; 
            levelTimeLimit = level.time; startTime = Date.now(); levelTimerActive = true;
            
            handles.forEach(h => { scene.remove(h.userData.light); scene.remove(h); });
            handles = [];
            if (knotMesh) scene.remove(knotMesh);
            if (ghostMesh) scene.remove(ghostMesh);

            targetPathPoints = [];
            for(let i=0; i<800; i++) targetPathPoints.push(getShapePoint((i/800)*Math.PI*2, level));

            ghostMesh = new THREE.Mesh(
                new THREE.TubeGeometry(new THREE.CatmullRomCurve3(targetPathPoints, true), 120, 0.15, 8, true), 
                new THREE.MeshStandardMaterial({ color: 0xff00ff, emissive: 0xff00ff, emissiveIntensity: 3, transparent: true, opacity: 0.35 })
            );
            scene.add(ghostMesh);

            const handleSize = isMobile ? 2.8 : 1.6;

            for (let i = 0; i < level.nodes; i++) {
                const handle = new THREE.Mesh(new THREE.SphereGeometry(handleSize, 8, 8), new THREE.MeshBasicMaterial({ transparent: true, opacity: 0 }));
                
                // GÃ–RÃœNÃœR DÃœÄžÃœM (Ã‡ok daha parlak)
                const visual = new THREE.Mesh(
                    new THREE.SphereGeometry(0.7, 16, 16), 
                    new THREE.MeshStandardMaterial({ color: 0xff0000, emissive: 0xff0000, emissiveIntensity: 6 })
                );
                
                // REAL-TIME IÅžIK KAYNAÄžI
                const pLight = new THREE.PointLight(0xff0000, 15, 8);
                handle.add(visual);
                handle.userData = { onRail: false, light: pLight };
                scene.add(pLight);
                
                const phi = Math.acos(-1 + (2 * i) / level.nodes);
                const theta = Math.sqrt(level.nodes * Math.PI) * phi;
                handle.position.set(32 * Math.sin(phi) * Math.cos(theta), 32 * Math.sin(phi) * Math.sin(theta), 32 * Math.cos(phi));
                pLight.position.copy(handle.position);
                
                scene.add(handle);
                handles.push(handle);
            }

            knotCurve = new THREE.CatmullRomCurve3(handles.map(h => h.position), true);
            lastSafePositions = handles.map(h => h.position.clone());
            setupDragControls();
            updateVisuals();
            document.getElementById('total-score-val').innerText = totalAccumulatedScore;
        }

        function restoreSafeState() {
            sfx.undo.play().catch(()=>{});
            collisionCooldown = true;
            handles.forEach((h, i) => {
                h.position.copy(lastSafePositions[i]);
                h.userData.light.position.copy(lastSafePositions[i]);
            });
            isLocked = false;
            document.getElementById('collision-lock').style.display = 'none';
            dragControls.enabled = true;
            updateVisuals();
            setTimeout(() => { collisionCooldown = false; }, 1000);
        }

        function updateVisuals() {
            if (knotMesh) scene.remove(knotMesh);
            knotCurve.points = handles.map(h => h.position);
            
            knotMesh = new THREE.Mesh(new THREE.TubeGeometry(knotCurve, 120, 0.6, 12, true), 
                new THREE.MeshStandardMaterial({ color: isLocked ? 0xff0000 : 0x00ccff, metalness: 0.8, roughness: 0.1 }));
            scene.add(knotMesh);

            let totalDev = 0;
            handles.forEach(h => {
                const dist = getClosestPointOnPath(h.position).dist;
                totalDev += dist;
                const active = h.userData.onRail;
                h.children[0].material.color.set(active ? 0x00ff00 : (dist < 4 ? 0xff8800 : 0xff0000));
                h.children[0].material.emissive.set(active ? 0x00ff00 : 0xff0000);
                h.userData.light.color.set(active ? 0x00ff00 : 0xff0000);
                h.userData.light.position.copy(h.position);
            });

            let percent = Math.max(0, 100 - (totalDev * 0.8));
            if (percent >= 98 && !bonusAwarded) {
                gameScore += 500; bonusAwarded = true;
                showScoreEffect(new THREE.Vector3(0, 15, 0), 500, false);
            }
            document.getElementById('bar-fill').style.width = percent + '%';
            document.getElementById('percent-val').innerText = Math.floor(percent);
        }

        function getShapePoint(t, level) {
            const r = level.radius;
            if (level.type === 'circle') return new THREE.Vector3(Math.cos(t) * r, 0, Math.sin(t) * r);
            if (level.type === 'heart') return new THREE.Vector3(16*Math.pow(Math.sin(t),3)*r, 0, (13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t))*r);
            if (level.type === 'star') { const rs = r + 3 * Math.sin(5 * t); return new THREE.Vector3(rs * Math.cos(t), 0, rs * Math.sin(t)); }
            if (level.type === 'torus') { const rt = r * (0.5 * (2 + Math.sin(level.q * t))); return new THREE.Vector3(rt * Math.cos(level.p * t), rt * Math.sin(level.p * t), r * 0.4 * Math.cos(level.q * t)); }
            if (level.type === 'figure8') return new THREE.Vector3((2 + Math.cos(2*t))*Math.cos(3*t)*(r/3), (2 + Math.cos(2*t))*Math.sin(3*t)*(r/3), Math.sin(4*t)*(r/2));
            if (level.type === 'sept') { const rs = r + 2.5 * Math.sin(7 * t); return new THREE.Vector3(rs * Math.cos(t), 0.5 * Math.cos(7*t), rs * Math.sin(t)); }
            return new THREE.Vector3(0,0,0);
        }

        function getClosestPointOnPath(pos) {
            let minDist = Infinity; let closestPos = new THREE.Vector3();
            targetPathPoints.forEach(p => { const d = pos.distanceTo(p); if (d < minDist) { minDist = d; closestPos = p; } });
            return { dist: minDist, pos: closestPos };
        }

        function checkVictory() {
            let totalDev = 0; handles.forEach(h => totalDev += getClosestPointOnPath(h.position).dist);
            let percent = 100 - (totalDev * 0.8);
            if (percent >= 98 && !checkCollision() && handles.every(h => h.userData.onRail)) {
                levelTimerActive = false; sfx.win.play().catch(()=>{});
                totalAccumulatedScore += gameScore;
                localStorage.setItem('topoTotalScore', totalAccumulatedScore);
                if (currentLevelIndex === unlockedLevel) { unlockedLevel++; localStorage.setItem('topoMaxLevel', unlockedLevel); }
                document.getElementById('win-screen').style.display = 'flex';
                document.getElementById('win-score-info').innerText = `BÃ–LÃœM SKORU: ${gameScore}`;
                updateUI();
            }
        }

        function updateUI() {
            document.getElementById('total-score-val').innerText = totalAccumulatedScore;
            document.getElementById('score-val').innerText = gameScore;
        }

        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            if (levelTimerActive && !isLocked) {
                const rem = levelTimeLimit - (Date.now() - startTime) / 1000;
                if (rem <= 0) {
                    levelTimerActive = false;
                    sfx.fail.play().catch(()=>{});
                    document.getElementById('fail-screen').style.display = 'flex';
                    document.getElementById('extra-rights-text').innerText = `Kalan Hak: ${3 - extraTimeAttempts}`;
                    document.getElementById('btn-extra').style.display = (extraTimeAttempts < 3) ? 'block' : 'none';
                }
                document.getElementById('timer-display').innerText = Math.max(0, rem).toFixed(1);
            }
            renderer.render(scene, camera);
        }

        const start = () => {
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 40, 70);
            scene.add(new THREE.AmbientLight(0xffffff, 1.4));
            
            const sun = new THREE.DirectionalLight(0x00ffff, 1);
            sun.position.set(10, 20, 10);
            scene.add(sun);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            
            const grid = document.getElementById('level-grid');
            levels.forEach((l, i) => {
                const card = document.createElement('div');
                card.className = `level-card ${i > unlockedLevel ? 'locked' : ''}`;
                card.innerHTML = `<div style="font-size:0.8rem; color:var(--neon)">LEVEL ${i+1}</div><div class="title">${l.name}</div>`;
                if (i <= unlockedLevel) card.onclick = () => loadLevel(i);
                grid.appendChild(card);
            });
            
            document.getElementById('undo-btn').onclick = restoreSafeState;
            document.getElementById('win-next-btn').onclick = () => loadLevel(currentLevelIndex + 1);
            document.getElementById('btn-extra').onclick = () => {
                if(extraTimeAttempts < 3) {
                    extraTimeAttempts++; startTime = Date.now();
                    levelTimerActive = true; document.getElementById('fail-screen').style.display = 'none';
                }
            };
            
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            
            updateUI();
            animate();
        };

        start();
    </script>
</body>
</html>