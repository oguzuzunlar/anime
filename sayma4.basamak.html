<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4. Basamak DeÄŸerlendirme - Sayma YÃ¶ntemleri</title>
    <!-- Favicon: Kupa/Ã–dÃ¼l ikonu -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Cpath fill='%232563eb' d='M2.5.5A.5.5 0 0 1 3 0h10a.5.5 0 0 1 .5.5c0 .538-.012 1.05-.034 1.536a3 3 0 1 1-1.133 5.89c-.79 1.865-1.878 2.777-2.833 3.011v2.173l1.425.356c.556.139.863.72.685 1.292-.139.445-.62.742-1.092.742h-7.5c-.472 0-.953-.297-1.092-.742-.178-.572.129-1.153.685-1.292l1.425-.356v-2.173c-.955-.234-2.043-1.146-2.833-3.012a3 3 0 1 1-1.132-5.89A33.076 33.076 0 0 1 2.5.5zm.099 2.54a2 2 0 0 0 .72 3.935c-.333-1.05-.588-2.346-.72-3.935zm10.083 3.935a2 2 0 0 0 .72-3.935c-.133 1.59-.388 2.885-.72 3.935zM3.504 1c.007.517.026 1.006.056 1.469.13 2.028.457 3.546.87 4.667C5.241 8.522 6.318 9.5 8 9.5c1.682 0 2.759-.978 3.57-2.364.413-1.121.74-2.64.87-4.667.03-.463.049-.952.056-1.469H3.504z'/%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- MathJax -->
    <script>
        MathJax = {
            tex: {
                packages: {'[+]': ['ams','noerrors']},
                inlineMath: [['$','$'], ['\\(','\\)']],
                displayMath: [['$$','$$'], ['\\[','\\]']],
                macros: { rm: ['\\mathrm{#1}', 1] }
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script"></script>
    <style>
        :root {
            --bg-color: #f0f9ff; --text-color: #0f172a; --card-bg: #ffffff; 
            --card-shadow: 0 4px 16px rgba(37, 99, 235, 0.15);
            /* Akademik Mavi Tema */
            --primary-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); 
            --secondary-bg: #eff6ff; --secondary-text: #1e40af;
            --header-color: #1d4ed8;
            --border-color: #bfdbfe;
            --evaluation-card-bg: rgba(255, 255, 255, 0.8);
        }
        .dark-mode {
            --bg-color: #0f172a; --text-color: #e2e8f0; --card-bg: #1e293b; 
            --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --secondary-bg: #172554; --secondary-text: #93c5fd;
            --header-color: #60a5fa;
            --border-color: #3b82f6;
            --evaluation-card-bg: rgba(30, 41, 59, 0.4);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-style: normal !important; }
        body, input, textarea, button, select { font-family: 'Inter', 'Poppins', sans-serif; color: var(--text-color); }
        mjx-container { max-width: 100%; overflow: hidden; }
        img, svg { max-width: 100%; height: auto; display: block; }
        
        body { background: var(--bg-color); color: var(--text-color); min-height: 100vh; line-height: 1.6; transition: 0.3s; }
        .container { max-width: 1100px; margin: 20px auto; padding: 0 15px; }
        
        /* Kart YapÄ±larÄ± */
        .header, .page { background: var(--card-bg); border-radius: 16px; box-shadow: var(--card-shadow); border: 1px solid rgba(255,255,255,0.1); }
        .header { padding: 25px; text-align: center; margin-bottom: 25px; position: relative; overflow: hidden; }
        .page { display: none; padding: 35px; animation: slideIn 0.5s ease; }
        .page.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        h1, h2, h3 { color: var(--header-color); font-weight: 700; margin-bottom: 15px; }
        h1 { font-size: 2.2rem; letter-spacing: -0.5px; }
        
        /* Tema Butonu */
        #theme-toggle { position: absolute; top: 20px; right: 20px; background: var(--secondary-bg); border: 1px solid var(--border-color); color: var(--secondary-text); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: 0.3s; }
        
        /* Butonlar */
        .button { background: var(--primary-gradient); color: white; border: none; padding: 14px 28px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: transform 0.2s, box-shadow 0.2s; }
        .button:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(37, 99, 235, 0.3); }
        .button.secondary { background: var(--secondary-bg); color: var(--secondary-text); }
        .button:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Soru AlanÄ± DÃ¼zeni */
        .problem-container { display: grid; grid-template-columns: 1fr 1.3fr; gap: 40px; }
        .context-card { background: var(--card-bg); border-radius: 12px; overflow: hidden; }
        .context-image-wrapper { 
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); 
            height: 180px; display: flex; align-items: center; justify-content: center;
            border-radius: 12px; margin-bottom: 20px; position: relative;
        }
        .context-icon { font-size: 5rem; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
        
        .question-group { background: var(--secondary-bg); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .question-group label { display: block; margin-bottom: 10px; font-size: 1.05rem; }
        .question-group input { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid var(--border-color); background: var(--bg-color); color: var(--text-color); font-size: 1.1rem; font-family: monospace; }
        .point-badge { float: right; background: var(--primary-gradient); color: white; padding: 2px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; }

        /* DeÄŸerlendirme KartlarÄ± */
        .evaluation-card { background: var(--evaluation-card-bg); border-left: 5px solid #ccc; padding: 20px; margin-bottom: 15px; border-radius: 8px; }
        #scoreCard { background: var(--primary-gradient); color: white; padding: 30px; border-radius: 16px; text-align: center; margin: 30px 0; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); padding: 20px; align-items: flex-start; justify-content: center; overflow-y: auto; }
        .modal-content { background: var(--card-bg); margin: 5vh auto; padding: 30px; border-radius: 16px; max-width: 800px; width: 100%; position: relative; border-top: 6px solid var(--header-color); overflow: hidden; }
        .close-button { position: absolute; right: 20px; top: 15px; font-size: 2rem; cursor: pointer; color: var(--text-color); opacity: 0.5; }
        .answer-block { background: var(--secondary-bg); padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid var(--header-color); overflow: hidden; }

        @media (max-width: 900px) { .problem-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body class="dark-mode">

<div class="container">
    <div class="header">
        <button id="theme-toggle">ğŸŒ™</button>
        <h1>4. Basamak DeÄŸerlendirme</h1>
        <h3 style="opacity: 0.8; font-weight: 500;">Sayma YÃ¶ntemleri</h3>
    </div>

    <!-- GÄ°RÄ°Å SAYFASI -->
    <div class="page active" id="page-intro">
        <div style="text-align: center;">
            <div style="max-width: 700px; margin: 20px auto 0; background: var(--secondary-bg); border-radius: 18px; box-shadow: var(--card-shadow); padding: 32px 28px 28px 28px; color: var(--secondary-text);">
                <h2 style="color: var(--header-color); font-size:2rem; margin-bottom:18px;">Bilgilendirme</h2>
                <ul style="list-style-type: none; padding-left: 0; font-size:1.08em; text-align:left; margin-bottom:28px; color: var(--text-color);">
                    <li style="margin-bottom:12px;">Bu deÄŸerlendirme sayma yÃ¶ntemleri konusundaki becerilerinizi Ã¶lÃ§mek amacÄ±yla hazÄ±rlanmÄ±ÅŸtÄ±r.</li>
                    <li style="margin-bottom:12px;"><strong>Problem:</strong> Size sunulan "Matematik OlimpiyatÄ±" senaryosuna dayalÄ± 3 soruyu cevaplayacaksÄ±nÄ±z.</li>
                    <li style="margin-bottom:12px;"><strong>Puanlama (Toplam 25 Puan):</strong> Her sorunun puan deÄŸeri yanÄ±nda belirtilmiÅŸtir. CevaplarÄ±nÄ±z yapay zeka tarafÄ±ndan deÄŸerlendirilecektir.</li>
                </ul>
                <div style="background: var(--card-bg); border-left: 5px solid var(--header-color); padding: 15px 20px; border-radius: 8px; text-align: left; margin-bottom: 25px;">
                    <h3 style="font-size: 1.1rem; display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">âš ï¸ YZ Destekli DeÄŸerlendirme HakkÄ±nda</h3>
                    <p style="margin: 0; font-size: 0.95em; opacity: 0.9;">Bu etkinlikte verilen otomatik deÄŸerlendirmeler ve geri bildirimler yapay zeka tarafÄ±ndan saÄŸlanmaktadÄ±r. AmaÃ§, Ã¶ÄŸrenmenize destek olmak ve farklÄ± Ã§Ã¶zÃ¼m yollarÄ±nÄ± gÃ¶stermektir. YZ Ã§Ä±ktÄ±larÄ± bir uzman gÃ¶rÃ¼ÅŸÃ¼nÃ¼n yerine geÃ§mez ve nadiren hatalar iÃ§erebilir.</p>
                </div>
                <button class="button" onclick="showPage('page-exam')" style="border-radius:24px; padding:12px 38px; font-size:1.15rem;">SÄ±nava BaÅŸla</button>
            </div>
        </div>
    </div>

    <!-- SINAV SAYFASI -->
    <div class="page" id="page-exam">
        <div class="problem-container">
            <!-- Sol Taraf: Senaryo -->
             
            <div class="problem-context">
                 <h3>Senaryo: Matematik OlimpiyatÄ±</h3>
                <div class="context-image-wrapper">
                    <div class="context-icon">ğŸ¥‡ğŸ¥ˆğŸ¥‰</div>
                </div>
               
                <p>3 kÄ±z 4 erkek Ã¶ÄŸrencinin katÄ±ldÄ±ÄŸÄ± bir matematik yarÄ±ÅŸmasÄ±nÄ±n sonuÃ§larÄ± aÃ§Ä±klanacaktÄ±r. YarÄ±ÅŸma sonucunda ilk 3 derece belirlenecektir.Her derecede en az bir Ã¶ÄŸrenci bulunmak zorundadÄ±r. Puan eÅŸitliÄŸi durumunda bir dereceyi birden fazla Ã¶ÄŸrenci paylaÅŸabilir.</p>
            
                
                <p>Buna gÃ¶re deÄŸerlendirme bÃ¶lÃ¼mÃ¼ndeki sorularÄ± cevaplayÄ±nÄ±z.</p>
            </div>

            <!-- SaÄŸ Taraf: Sorular -->
            <div class="problem-questions">
                <h3>DeÄŸerlendirme SÄ±navÄ±</h3>
                <!-- Remaining questions: only 4,5,6 are shown per user request -->

                <!-- Soru 4 -->
                <div class="question-group">
                    <label>
                        <span class="point-badge">7 Puan</span>
                        <strong>SORU 1)</strong><br>
                        Ä°lk 3 derece 3 Ã¶ÄŸrenci tarafÄ±ndan paylaÅŸÄ±ldÄ±ysa, ilk 3 derece alan Ã¶ÄŸrencilerden en az bir tanesinin kÄ±z olduÄŸu kaÃ§ farklÄ± sonuÃ§ vardÄ±r?
                    </label>
                    <input type="number" id="q1_input" placeholder="Sonucu giriniz...">
                </div>

                <!-- Soru 5 -->
                <div class="question-group">
                    <label>
                        <span class="point-badge">6 Puan</span>
                        <strong>SORU 2)</strong><br>
                        Ä°lk 3 derece toplam 4 farklÄ± Ã¶ÄŸrenci tarafÄ±ndan paylaÅŸÄ±ldÄ±ysa, ilk 4 Ã¶ÄŸrenci arasÄ±ndan en az birinin kÄ±z olduÄŸu kaÃ§ farklÄ± sonuÃ§ vardÄ±r?
                    </label>
                    <input type="number" id="q2_input" placeholder="Sonucu giriniz...">
                </div>

                <!-- Soru 6 -->
                <div class="question-group">
                    <label>
                        <span class="point-badge">12 Puan</span>
                        <strong>SORU 3)</strong><br>
                        Ä°lk 3 derece toplam 5 farklÄ± Ã¶ÄŸrenci tarafÄ±ndan paylaÅŸÄ±ldÄ±ysa, ilk 5 Ã¶ÄŸrenci arasÄ±nda en az bir kÄ±z olduÄŸu kaÃ§ farklÄ± sonuÃ§ vardÄ±r?
                    </label>
                    <input type="number" id="q3_input" placeholder="Sonucu giriniz...">
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <button class="button" id="finish-exam-btn" onclick="checkAndFinish()">SÄ±navÄ± Bitir ve DeÄŸerlendir</button>
            <button class="button" id="view-results-btn" onclick="showPage('page-evaluation')" style="display:none;">SonuÃ§larÄ± GÃ¶r</button>
        </div>
    </div>

    <!-- DEÄERLENDÄ°RME SAYFASI -->
    <div class="page" id="page-evaluation">
        <h2 style="text-align:center;">DeÄŸerlendirme SonuÃ§larÄ±</h2>
        <div id="scoreCard">
            <div style="font-size: 1.1rem; opacity: 0.9;">TOPLAM PUAN</div>
            <div id="finalScore" style="font-size: 3.5rem; font-weight: 800;">-- / 25</div>
            <div id="finalPercentage" style="font-size: 1.2rem; font-weight: 600;">--%</div>
        </div>
        
        <div id="aiStatus" style="text-align:center; color: var(--secondary-text); margin-bottom: 20px; font-style:italic;">
            YanÄ±tlarÄ±nÄ±z analiz ediliyor...
        </div>

        <div id="evaluationContent">
            <!-- Dinamik iÃ§erik buraya gelecek -->
        </div>

        <div style="text-align: center; margin-top: 30px; gap: 15px; display: flex; justify-content: center;">
            <button class="button secondary" onclick="showPage('page-exam')">SÄ±nava DÃ¶n</button>
            <button class="button" onclick="openSolutionsModal()">DetaylÄ± Ã‡Ã¶zÃ¼mleri GÃ¶r</button>
        </div>
    </div>
</div>

<!-- Ã‡Ã–ZÃœM MODALI -->
<div id="solution-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeSolutionsModal()">&times;</span>
        <h2 style="color: var(--header-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px;">Ã‡Ã¶zÃ¼m AnahtarÄ±</h2>
        <div id="solutionContent">
            <!-- JS ile doldurulacak -->
        </div>
    </div>
</div>

<script>
    // --- TEMEL FONKSÄ°YONLAR ---
    document.addEventListener('DOMContentLoaded', () => {
        setupThemeToggle();
    });

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        window.scrollTo(0,0);
    }

    function setupThemeToggle() {
        const toggle = document.getElementById('theme-toggle');
        // VarsayÄ±lan olarak her zaman dark mode
        let isDark = true;
        
        const applyTheme = () => {
            if(isDark) { document.body.classList.add('dark-mode'); toggle.textContent = 'â˜€ï¸'; }
            else { document.body.classList.remove('dark-mode'); toggle.textContent = 'ğŸŒ™'; }
        };
        applyTheme();

        toggle.addEventListener('click', () => {
            isDark = !isDark;
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            applyTheme();
        });
    }

    // --- LMS PUAN GÃ–NDERME ---
    function sendScoreToLMS(ogrenciPuani) {
        var result = { 
            score: { max: 25, min: 0, raw: ogrenciPuani, scaled: ogrenciPuani / 25 }, 
            completion: true, 
            success: true 
        };
        try {
            var lmsWindow = window.parent.document.getElementById("frmApp-0")?.contentWindow;
            if (lmsWindow?.onCompleted) { 
                lmsWindow.onCompleted(result); 
                console.log("âœ… LMS'ye puan gÃ¶nderildi:", ogrenciPuani);
            } else { 
                console.warn("âš ï¸ LMS baÄŸlantÄ±sÄ± bulunamadÄ±, puan yerel olarak kaydedildi."); 
            }
        } catch (e) { 
            console.error('LMS ile iletiÅŸim sÄ±rasÄ±nda hata:', e); 
        }
    }

    // --- DEÄERLENDÄ°RME MANTIÄI ---
    
    let examFinished = false;
    
    // DoÄŸru Cevaplar (7 katÄ±lÄ±mcÄ± iÃ§in: Q1,Q2,Q3)
    const correctAnswers = {
        q1: 186,  // 1) En az 1 kÄ±z (beraberlik yok)
        q2: 1224, // 2) k=4 (2-1-1)
        q3: 3150  // 3) k=5 (3-1-1 veya 2-2-1)
    };

    // Alternatif Ã§Ã¶zÃ¼mler ve kÄ±smi puan mantÄ±ÄŸÄ±
    const alternativeAnswers = {
        q1: [
            { value: 210, points: 4, explanation: "Toplam durumu buldunuz ama tÃ¼mleyen hesabÄ± yapÄ±lmamÄ±ÅŸ." },
            { value: 24, points: 3, explanation: "Sadece tÃ¼mÃ¼ erkek durumunu hesapladÄ±nÄ±z." }
        ],
        q2: [
            { value: 1260, points: 4, explanation: "Toplam durumu buldunuz ama tÃ¼mleyen hesabÄ± yapÄ±lmamÄ±ÅŸ." },
            { value: 36, points: 2, explanation: "Sadece tÃ¼mÃ¼ erkek durumunu hesapladÄ±nÄ±z." },
            { value: 420, points: 2, explanation: "Tek konum iÃ§in doÄŸru hesapladÄ±nÄ±z ama 3 konumu Ã§arpmadÄ±nÄ±z." }
        ],
        q3: [
            { value: 1260, points: 5, explanation: "Sadece 3-1-1 Ã¶rÃ¼ntÃ¼sÃ¼nÃ¼ hesapladÄ±nÄ±z, 2-2-1 Ã¶rÃ¼ntÃ¼sÃ¼ eksik." },
            { value: 1890, points: 5, explanation: "Sadece 2-2-1 Ã¶rÃ¼ntÃ¼sÃ¼nÃ¼ hesapladÄ±nÄ±z, 3-1-1 Ã¶rÃ¼ntÃ¼sÃ¼ eksik." },
            { value: 420, points: 3, explanation: "Tek konum iÃ§in 3-1-1 hesabÄ± doÄŸru ama eksik." },
            { value: 630, points: 3, explanation: "Tek konum iÃ§in 2-2-1 hesabÄ± doÄŸru ama eksik." }
        ]
    };

    async function checkAndFinish() {
        document.getElementById('finish-exam-btn').disabled = true;
        showPage('page-evaluation');
        
        const userAnswers = {
            q1: parseInt(document.getElementById('q1_input').value) || 0,
            q2: parseInt(document.getElementById('q2_input').value) || 0,
            q3: parseInt(document.getElementById('q3_input').value) || 0
        };

        let totalScore = 0;

        try {
            // Yapay Zeka DeÄŸerlendirmesi
            if (!navigator.onLine) { throw new Error("Ä°nternet baÄŸlantÄ±sÄ± yok."); }
            
            document.getElementById('aiStatus').innerHTML = '<span style="color: var(--header-color);">ğŸ¤– Yapay zeka yanÄ±tlarÄ±nÄ±zÄ± analiz ediyor...</span>';
            
            const prompt = buildAIScoringPrompt(userAnswers);
            const result = await callGemini(prompt);
            const evaluation = formatAIScoringResponse(result, userAnswers);
            
            document.getElementById('evaluationContent').innerHTML = evaluation.html;
            document.getElementById('aiStatus').innerHTML = '<span style="color: #10b981;">âœ… Yapay zeka deÄŸerlendirmesi tamamlandÄ±.</span>';
            totalScore = evaluation.score || 0;
            
        } catch (err) {
            console.warn("YZ DeÄŸerlendirmesi BaÅŸarÄ±sÄ±z:", err);
            totalScore = runFallbackEvaluation(userAnswers, err);
        }

        // Skor kartÄ±nÄ± gÃ¼ncelle
        updateScoreDisplay(totalScore);
        
        // LMS'ye puan gÃ¶nder
        try { sendScoreToLMS(totalScore); } catch (sendErr) { console.error('LMS gÃ¶nderimi baÅŸarÄ±sÄ±z:', sendErr); }
        
        // Ã‡Ã¶zÃ¼m modalÄ±nÄ± hazÄ±rla
        populateSolutionModal();
        
        // SÄ±navÄ± kilitle - tekrar Ã§Ã¶zÃ¼lemesin
        examFinished = true;
        document.getElementById('q1_input').disabled = true;
        document.getElementById('q2_input').disabled = true;
        document.getElementById('q3_input').disabled = true;
        document.getElementById('finish-exam-btn').style.display = 'none';
        document.getElementById('view-results-btn').style.display = 'inline-block';
    }

    // --- YAPAY ZEKA DEÄERLENDÄ°RME ---
    async function callGemini(prompt) {
        const apiKey = "AIzaSyCEhU3erLOAJB9cADTqaGanVidc2DRbhr8";
        if (!apiKey || apiKey === "YOUR_API_KEY") throw new Error("GeÃ§erli bir API anahtarÄ± girilmedi.");

        const models = ['gemini-2.0-flash', 'gemini-2.5-flash', 'gemini-2.5-pro'];
        const timeoutMs = 8000;

        for (const model of models) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                const body = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(url, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(body), 
                    signal: controller.signal 
                });
                clearTimeout(timeoutId);

                if (!response.ok) continue;

                const json = await response.json();
                const text = json?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) continue;

                console.log('YZ deÄŸerlendirmesinde baÅŸarÄ±lÄ± model:', model);
                return text;
            } catch (err) {
                clearTimeout(timeoutId);
                continue;
            }
        }
        throw new Error('TÃ¼m YZ modelleri baÅŸarÄ±sÄ±z oldu.');
    }

    function buildAIScoringPrompt(data) {
        return `UZMAN MATEMATÄ°K DEÄERLENDÄ°RME Ä°STEÄÄ°

GÃ–REV: AÅŸaÄŸÄ±daki 3 soruluk matematik sÄ±navÄ±nÄ± rubrik esaslÄ± deÄŸerlendir. SADECE JSON Ã§Ä±ktÄ±sÄ± Ã¼ret.

PROBLEM BAÄLAMI:
3 kÄ±z, 4 erkek toplam 7 Ã¶ÄŸrencinin katÄ±ldÄ±ÄŸÄ± bir yarÄ±ÅŸmada ilk 3 derece belirleniyor.
Her derecede en az 1 Ã¶ÄŸrenci olmalÄ±, beraberlik durumunda bir dereceyi birden fazla Ã¶ÄŸrenci paylaÅŸabilir.

DOÄRU CEVAPLAR:
- q1: 186 (Beraberlik yoksa en az 1 kÄ±z: P(7,3) - P(4,3) = 210 - 24 = 186)
- q2: 1224 (4 Ã¶ÄŸrenci dereceye girdiyse, 2-1-1 Ã¶rÃ¼ntÃ¼sÃ¼: 1260 - 36 = 1224)
- q3: 3150 (5 Ã¶ÄŸrenci dereceye girdiyse, 3-1-1 ve 2-2-1 Ã¶rÃ¼ntÃ¼leri: 1260 + 1890 = 3150, tÃ¼mÃ¼ zaten en az 1 kÄ±z iÃ§erir)

ALTERNATÄ°F CEVAPLAR VE KISMI PUANLAR:
- q1 (maks 7): 186=7p, 210=4p (toplam durum), 24=3p (tÃ¼mleyen)
- q2 (maks 6): 1224=6p, 1260=4p (toplam), 36=2p (tÃ¼mleyen), 420=2p (tek konum)
- q3 (maks 12): 3150=12p, 1260=5p (sadece 3-1-1), 1890=5p (sadece 2-2-1), 420=3p, 630=3p

Ã–ÄRENCÄ° YANITLARI: ${JSON.stringify(data)}

JSON FORMATI:
{
    "q1": {"puan": <0-7>, "aciklama": "...", "ogrenci_cevabi": <deÄŸer>},
    "q2": {"puan": <0-6>, "aciklama": "...", "ogrenci_cevabi": <deÄŸer>},
    "q3": {"puan": <0-12>, "aciklama": "...", "ogrenci_cevabi": <deÄŸer>},
    "toplam_puan": <0-25>,
    "genel_geri_bildirim": "..."
}`;
    }

    function formatAIScoringResponse(raw, userAnswers) {
        let parsed;
        try { 
            parsed = JSON.parse(raw.trim().replace(/^```json\s*|```\s*$/g, '')); 
        } catch (e) { 
            throw new Error("YZ yanÄ±tÄ± JSON formatÄ±nda deÄŸil."); 
        }

        const questions = [
            { id: 'q1', title: 'Soru 1: Beraberlik Yoksa En Az Bir KÄ±z', max: 7 },
            { id: 'q2', title: 'Soru 2: 4 Ã–ÄŸrenci Dereceye Girdiyse (2-1-1)', max: 6 },
            { id: 'q3', title: 'Soru 3: 5 Ã–ÄŸrenci Dereceye Girdiyse', max: 12 }
        ];

        let html = '';
        let totalScore = 0;

        questions.forEach((q) => {
            const data = parsed[q.id];
            if (data) {
                const puan = Math.min(Number(data.puan) || 0, q.max);
                totalScore += puan;
                const aciklama = data.aciklama || data.aÃ§Ä±klama || '';
                const ogrCevap = data.ogrenci_cevabi ?? userAnswers[q.id];
                
                html += createEvalCardAI(q.title, puan, q.max, ogrCevap, correctAnswers[q.id], aciklama);
            }
        });

        return { html, score: totalScore };
    }

    function createEvalCardAI(title, score, max, userAns, correctAns, aciklama) {
        const perc = max > 0 ? (score/max)*100 : 0;
        const color = perc >= 99 ? '#10b981' : (perc >= 50 ? '#f59e0b' : '#ef4444');
        
        return `
        <div class="evaluation-card" style="border-left-color: ${color}">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0;">${title}</h4>
                <div style="font-weight:bold; color:${color}">${score} / ${max} Puan</div>
            </div>
            <div>
                <div><strong>Sizin CevabÄ±nÄ±z:</strong> ${escapeHtml(String(userAns))}</div>
                <div><strong>DoÄŸru Cevap:</strong> ${correctAns}</div>
                ${aciklama ? `<div style="margin-top:8px; padding:10px; background:rgba(0,0,0,0.05); border-radius:6px;"><strong>AÃ§Ä±klama:</strong> ${escapeHtml(aciklama)}</div>` : ''}
            </div>
        </div>`;
    }

    // --- STANDART DEÄERLENDÄ°RME (Alternatif Ã‡Ã¶zÃ¼mlerle) ---
    function runFallbackEvaluation(userAnswers, error) {
        document.getElementById('aiStatus').innerHTML = '<span style="color: #f59e0b;">âš ï¸ Yapay zeka kullanÄ±lamadÄ±, standart deÄŸerlendirme yapÄ±ldÄ±.</span>';
        
        const scores = calculateScoresWithAlternatives(userAnswers);
        const totalScore = scores.q1.points + scores.q2.points + scores.q3.points;
        
        let html = '';
        html += createEvalCardFallback('Soru 1: Beraberlik Yoksa En Az Bir KÄ±z', scores.q1, 7, userAnswers.q1, correctAnswers.q1);
        html += createEvalCardFallback('Soru 2: 4 Ã–ÄŸrenci Dereceye Girdiyse (2-1-1)', scores.q2, 6, userAnswers.q2, correctAnswers.q2);
        html += createEvalCardFallback('Soru 3: 5 Ã–ÄŸrenci Dereceye Girdiyse', scores.q3, 12, userAnswers.q3, correctAnswers.q3);
        
        document.getElementById('evaluationContent').innerHTML = html;
        return totalScore;
    }

    function calculateScoresWithAlternatives(inputs) {
        let results = {};
        
        // Soru 1
        if (inputs.q1 === correctAnswers.q1) {
            results.q1 = { points: 7, explanation: "MÃ¼kemmel! DoÄŸru cevap." };
        } else {
            const alt = alternativeAnswers.q1.find(a => a.value === inputs.q1);
            if (alt) {
                results.q1 = { points: alt.points, explanation: alt.explanation };
            } else {
                results.q1 = { points: 0, explanation: "Cevap doÄŸru deÄŸil. TÃ¼mleyen yÃ¶ntemi kullanÄ±n: Toplam - TÃ¼mÃ¼ erkek." };
            }
        }
        
        // Soru 2
        if (inputs.q2 === correctAnswers.q2) {
            results.q2 = { points: 6, explanation: "MÃ¼kemmel! DoÄŸru cevap." };
        } else {
            const alt = alternativeAnswers.q2.find(a => a.value === inputs.q2);
            if (alt) {
                results.q2 = { points: alt.points, explanation: alt.explanation };
            } else {
                results.q2 = { points: 0, explanation: "Cevap doÄŸru deÄŸil. 2-1-1 Ã¶rÃ¼ntÃ¼sÃ¼ iÃ§in 3 farklÄ± konumu hesaplayÄ±n." };
            }
        }
        
        // Soru 3
        if (inputs.q3 === correctAnswers.q3) {
            results.q3 = { points: 12, explanation: "MÃ¼kemmel! DoÄŸru cevap." };
        } else {
            const alt = alternativeAnswers.q3.find(a => a.value === inputs.q3);
            if (alt) {
                results.q3 = { points: alt.points, explanation: alt.explanation };
            } else {
                results.q3 = { points: 0, explanation: "Cevap doÄŸru deÄŸil. 3-1-1 ve 2-2-1 Ã¶rÃ¼ntÃ¼lerini ayrÄ± ayrÄ± hesaplayÄ±p toplayÄ±n." };
            }
        }
        
        return results;
    }

    function createEvalCardFallback(title, scoreData, max, userAns, correctAns) {
        const perc = max > 0 ? (scoreData.points/max)*100 : 0;
        const color = perc >= 99 ? '#10b981' : (perc >= 50 ? '#f59e0b' : '#ef4444');
        
        return `
        <div class="evaluation-card" style="border-left-color: ${color}">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h4 style="margin:0;">${title}</h4>
                <div style="font-weight:bold; color:${color}">${scoreData.points} / ${max} Puan</div>
            </div>
            <div>
                <div><strong>Sizin CevabÄ±nÄ±z:</strong> ${userAns}</div>
                <div><strong>DoÄŸru Cevap:</strong> ${correctAns}</div>
                <div style="margin-top:8px; padding:10px; background:rgba(0,0,0,0.05); border-radius:6px;">
                    <strong>Geri Bildirim:</strong> ${scoreData.explanation}
                </div>
            </div>
        </div>`;
    }

    function updateScoreDisplay(totalScore) {
        document.getElementById('finalScore').textContent = `${totalScore} / 25`;
        const percent = Math.round((totalScore/25)*100);
        document.getElementById('finalPercentage').textContent = `%${percent}`;
        
        const card = document.getElementById('scoreCard');
        if(percent >= 80) card.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        else if(percent >= 50) card.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
        else card.style.background = 'linear-gradient(135deg, #ef4444, #b91c1c)';
    }

    function escapeHtml(str) { 
        return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;'); 
    }

    // --- Ã‡Ã–ZÃœM MODALI ---
    const modal = document.getElementById('solution-modal');

    function openSolutionsModal() {
        modal.style.display = 'flex';
        if (window.MathJax) {
            const node = document.getElementById('solutionContent');
            try { if (MathJax.typesetClear) MathJax.typesetClear(); } catch(e) {}
            if (MathJax.startup && MathJax.startup.promise) {
                MathJax.startup.promise.then(() => {
                    MathJax.typesetPromise([node]).catch((err) => console.error('MathJax typeset failed:', err));
                }).catch((err) => console.error('MathJax startup failed:', err));
            } else {
                MathJax.typesetPromise([node]).catch((err) => console.error('MathJax typeset failed:', err));
            }
        }
    }
    
    function closeSolutionsModal() {
        modal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == modal) closeSolutionsModal();
    }

    function populateSolutionModal() {
        const content = document.getElementById('solutionContent');
        content.innerHTML = `
            <div class="answer-block">
                <h4>SORU 1 â€” Beraberlik Yoksa En Az Bir KÄ±z</h4>
                <p><strong>Ã‡Ã¶zÃ¼m:</strong> TÃ¼mleyen yÃ¶ntemi kullanÄ±yoruz.</p>
                <p>Toplam: $$\\mathrm{P}(7,3) = 210$$</p>
                <p>TÃ¼mÃ¼ erkek: $$\\mathrm{P}(4,3) = 24$$</p>
                <p><strong>SonuÃ§:</strong> $$210 - 24 = \\mathbf{186}$$</p>
            </div>

            <div class="answer-block">
                <h4>SORU 2 â€” 4 Ã–ÄŸrenci Dereceye Girdiyse (2-1-1)</h4>
                <p><strong>Ã‡Ã¶zÃ¼m:</strong> 2-1-1 Ã¶rÃ¼ntÃ¼sÃ¼ iÃ§in konum sayÄ±sÄ± (tekrarlÄ± permÃ¼tasyon):</p>
                <p>$$\\frac{3!}{1! \\cdot 1! \\cdot 1!} = 6 \\div 2 = 3$$ konum (aynÄ± eleman sayÄ±larÄ±: iki tane 1)</p>
                <p>Toplam: $$\\mathrm{C}(7,2) \\times \\mathrm{P}(5,2) \\times 3 = 21 \\times 20 \\times 3 = 1260$$</p>
                <p>TÃ¼mÃ¼ erkek: $$\\mathrm{C}(4,2) \\times \\mathrm{P}(2,2) \\times 3 = 6 \\times 2 \\times 3 = 36$$</p>
                <p><strong>SonuÃ§:</strong> $$1260 - 36 = \\mathbf{1224}$$</p>
            </div>

            <div class="answer-block">
                <h4>SORU 3 â€” 5 Ã–ÄŸrenci Dereceye Girdiyse</h4>
                <p><strong>Ã‡Ã¶zÃ¼m:</strong> Ä°ki Ã¶rÃ¼ntÃ¼ var: (3-1-1) ve (2-2-1)</p>
                <p><strong>Ã–rÃ¼ntÃ¼ A (3-1-1):</strong> Konum sayÄ±sÄ±: $$\\frac{3!}{1! \\cdot 2!} = 3$$ (iki tane 1 tekrar ediyor)</p>
                <p>$$\\mathrm{C}(7,3) \\times \\mathrm{P}(4,2) \\times 3 = 35 \\times 12 \\times 3 = 1260$$</p>
                <p><strong>Ã–rÃ¼ntÃ¼ B (2-2-1):</strong> Konum sayÄ±sÄ±: $$\\frac{3!}{2! \\cdot 1!} = 3$$ (iki tane 2 tekrar ediyor)</p>
                <p>$$\\mathrm{C}(7,2) \\times \\mathrm{C}(5,2) \\times 3 \\times 3 = 21 \\times 10 \\times 3 \\times 3 = 1890$$</p>
                <p>Toplam: $$1260 + 1890 = 3150$$</p>
                <p>5 kiÅŸi seÃ§ildiÄŸinde en az 1 kÄ±z olmak zorunda (sadece 4 erkek var).</p>
                <p><strong>SonuÃ§:</strong> $$\\mathbf{3150}$$</p>
            </div>
        `;
        // MathJax'i tetikle
        if (window.MathJax) {
            const node = document.getElementById('solutionContent');
            try { if (MathJax.typesetClear) MathJax.typesetClear(); } catch(e) {}
            if (MathJax.startup && MathJax.startup.promise) {
                MathJax.startup.promise.then(() => {
                    MathJax.typesetPromise([node]).catch((err) => console.error('MathJax typeset failed:', err));
                }).catch((err) => console.error('MathJax startup failed:', err));
            } else {
                MathJax.typesetPromise([node]).catch((err) => console.error('MathJax typeset failed:', err));
            }
        }
    }
</script>
</body>
</html>