<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>5. Basamak DeÄŸerlendirme</title>
    <!-- Inline SVG favicon -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3E%3Crect width='16' height='16' rx='3' fill='%237c3aed'/%3E%3Ctext x='8' y='11' font-size='9' font-family='Poppins, Arial' fill='white' text-anchor='middle'%3EA%3C/text%3E%3C/svg%3E">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f5f3ff; --text-color: #3b0764; --card-bg: #ffffff; --card-shadow: 0 4px 16px rgba(124, 58, 237, 0.15);
            --primary-gradient: linear-gradient(135deg, #a78bfa 0%, #7c3aed 100%);
            --secondary-bg: #ede9fe; --secondary-text: #6d28d9;
            --header-color: #7c3aed; --border-color: #c4b5fd;
            --evaluation-card-bg: rgba(255, 255, 255, 0.7);
        }
        .dark-mode {
            --bg-color: #1f1633; --text-color: #ddd6fe; --card-bg: #2a1f4d; --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --secondary-bg: #3b2965; --secondary-text: #c4b5fd;
            --header-color: #a78bfa; --border-color: #d8b4fe;
            --evaluation-card-bg: rgba(0, 0, 0, 0.25);
        }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body, input, textarea, button { font-family: 'Poppins', sans-serif; }
    body { background: var(--bg-color); color: var(--text-color); min-height: 100vh; transition: background-color 0.3s, color 0.3s; line-height: 1.6; }
    .container { max-width: 1400px; margin: 20px auto; padding: 0 15px; }
    .header { background: var(--card-bg); border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 20px; box-shadow: var(--card-shadow); position: relative; border: 3px solid var(--border-color); }
    #theme-toggle { position: absolute; top: 15px; right: 15px; background: var(--secondary-bg); color: var(--secondary-text); border: none; width: 44px; height: 44px; border-radius: 50%; cursor: pointer; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
    .page { display: none; background: var(--card-bg); border-radius: 15px; padding: 30px; box-shadow: var(--card-shadow); animation: slideIn 0.5s ease; }
    .page.active { display: block; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    h1, h2, h3, h4 { margin-bottom: 15px; color: var(--header-color); font-weight: 600; }
    h1 { font-size: 2rem; } h2 { font-size: 1.7rem; }
    .button { background: var(--primary-gradient); color: #fff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s ease; margin: 5px; }
    .button:disabled { opacity: 0.5; cursor: not-allowed; }
    .problem-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: start; }
    .problem-context .context-image { width: 100%; border-radius: 10px; box-shadow: var(--card-shadow); border: 2px solid var(--border-color); margin-bottom: 20px; }
    .question-group { margin-bottom: 20px; background-color: var(--secondary-bg); padding: 20px; border-radius: 12px; }
    .point-badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: var(--card-bg); color: var(--secondary-text); border: 1px solid var(--border-color); font-size: 0.85rem; font-weight: 700; }
    .question-group > label { font-weight: 400; display: block; margin-bottom: 8px; }
    .question-group input, .question-group textarea { width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 6px; background: var(--bg-color); color: var(--text-color); font-size: 1rem; resize: vertical; }
    .multi-input-container { display: grid; grid-template-columns: auto 1fr; gap: 10px 15px; align-items: center; }
    .multi-input-container label { font-weight: 600; text-align: right; }
    .blank-fill-list { list-style: none; padding: 0; }
    /* Soru 4 satÄ±r dÃ¼zeni: metin solda, kutu saÄŸda hizalÄ± */
    .blank-fill-list li { display: grid; grid-template-columns: 1fr minmax(200px, 360px); align-items: center; gap: 12px; margin-bottom: 12px; }
    .blank-fill-list li .fill { width: 100%; }
    .blank-fill-list li .fill.small { max-width: 120px; }
    .blank-fill-list li .fill-inline { display: flex; align-items: center; gap: 8px; }
    .blank-fill-list li .fill-inline .paren { font-weight: 700; opacity: .9; }
    .blank-fill-list li.full-row { grid-template-columns: 1fr; }
    .inline-input { width: 120px; max-width: 160px; display: inline-block; vertical-align: baseline; }
    /* Matematiksel ifadeler satÄ±r bÃ¶lÃ¼nmeden kalsÄ±n */
    .math-inline { white-space: nowrap; display: inline-block; }
    code { font-family: inherit; font-size: 1em; font-weight: 600; background: rgba(0,0,0,0.08); padding: 0 6px; border-radius: 6px; white-space: nowrap; display: inline-block; line-height: 1.2; }
    @media (max-width: 700px) { .blank-fill-list li { grid-template-columns: 1fr; } }
    /* DeÄŸerlendirme ve modal stilleri */
    .evaluation-card { background: var(--evaluation-card-bg); border-left: 5px solid; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
    .answer-block { background: var(--secondary-bg); padding: 20px; border-radius: 8px; margin-bottom: 15px; text-align: left; }
    .answer-block h4 { color: var(--secondary-text); border-bottom: 2px solid var(--border-color); padding-bottom: 8px; margin-bottom: 12px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
    .modal-content { background-color: var(--card-bg); margin: 5% auto; padding: 25px; border-radius: 15px; max-width: 700px; width: 90%; position: relative; box-shadow: var(--card-shadow); }
    .close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; }
    #scoreCard { border-radius: 12px; text-align: center; margin: 20px 0; color: white; padding: 20px; }
    .spinner { width: 3rem; height: 3rem; color: var(--header-color); border: .25em solid currentColor; border-right-color: transparent; border-radius: 50%; display: inline-block; animation: spinner-border .75s linear infinite; }
    @keyframes spinner-border { to { transform: rotate(360deg); } }
    
    @media (max-width: 1100px) { .problem-container { grid-template-columns: 1fr; } }
    @media (max-width: 900px) { .page { padding: 20px; } h1 { font-size: 1.8rem; } h2 { font-size: 1.5rem; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button id="theme-toggle" title="TemayÄ± DeÄŸiÅŸtir">â˜€ï¸</button>
            <h1 style="margin-bottom:0.3em;">5. Basamak DeÄŸerlendirme</h1>
            <h2 style="margin-top:0; font-size:1.5rem;">Algoritmik YapÄ± OluÅŸturma</h2>
        </div>
        <div class="page active" id="page-intro">
            <div style="max-width: 900px; margin: 0 auto;">
                <div style="background: var(--secondary-bg); border-radius: 18px; padding: 32px 28px; border: 3px solid var(--border-color);">
                    <h2 style="color: var(--header-color); font-size:2rem; margin-bottom:18px; text-align:center;">DeÄŸerlendirme HakkÄ±nda</h2>
                    <div style="font-size:1.06em; color: var(--text-color); line-height:1.75; max-width: 720px; margin: 0 auto;">
                        <p style="margin-bottom:12px; text-align: left;">Bu deÄŸerlendirme, algoritmik yapÄ± oluÅŸturma konusundaki becerilerinizi Ã¶lÃ§meyi amaÃ§lar.</p>
                        <p style="margin-bottom:12px; text-align: left;"><strong>Puanlama (Toplam 30 Puan):</strong> SÄ±nav 5 sorudan oluÅŸmaktadÄ±r. SorularÄ±n puan deÄŸerleri yanlarÄ±nda belirtilmiÅŸtir. CevaplarÄ±nÄ±z yapay zeka tarafÄ±ndan deÄŸerlendirilecektir.</p>
                        

                        <div style="border: 3px solid var(--border-color); border-radius:16px; padding:16px 18px; background: var(--card-bg);">
                            <div style="display:flex; align-items:center; gap:10px; font-weight:700; color: var(--secondary-text); margin-bottom:6px;">
                                <span style="font-size:1.2rem;">âš ï¸</span>
                                <span>YZ Destekli DeÄŸerlendirme HakkÄ±nda</span>
                            </div>
                            <p style="margin:0; color: var(--text-color); text-align:left;">Bu etkinlikte verilen otomatik deÄŸerlendirmeler ve geri bildirimler yapay zeka tarafÄ±ndan saÄŸlanmaktadÄ±r. AmaÃ§, Ã¶ÄŸrenmenize destek olmak ve farklÄ± Ã§Ã¶zÃ¼m yollarÄ±nÄ± gÃ¶stermektir. YZ Ã§Ä±ktÄ±larÄ± bir uzman gÃ¶rÃ¼ÅŸÃ¼nÃ¼n yerine geÃ§mez ve nadiren hatalar iÃ§erebilir.</p>
                        </div>

                        <div style="text-align:center; margin-top:28px;">
                            <button class="button" onclick="showPage('page-stage1')" style="border-radius:24px; padding:12px 38px; font-size:1.15rem;">SÄ±nava BaÅŸla</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="page" id="page-stage1">
           
            <div class="problem-container">
                <div class="problem-context">
                    <h4>Problem Senaryosu ve AkÄ±ÅŸ ÅemalarÄ±</h4>
                    <p>Bir Ã¶ÄŸrenci <span class="math-inline">f : N â†’ N</span>, <span class="math-inline">f(n) = nÂ² + n + 41</span> fonksiyonunu kullanarak asal sayÄ±lar elde etmek istiyor. AÅŸaÄŸÄ±da, bu ifadeyi <span class="math-inline">n = 0'dan 50'ye</span> kadar test eden ve sadece asal sonuÃ§larÄ± ekrana yazdÄ±ran aynÄ± amaca hizmet eden fakat farklÄ± yÃ¶ntemler kullanan iki algoritma gÃ¶sterimi bulunmaktadÄ±r.<br>Buna gÃ¶re algoritmalarÄ± inceleyerek deÄŸerlendirme sÄ±navÄ± bÃ¶lÃ¼mÃ¼ndeki sorularÄ± cevaplayÄ±nÄ±z.</p>
                    <h4>Algoritma 1</h4>
                    <img src="resim1.png" alt="Algoritma 1 - KoÅŸul kontrollÃ¼ (while) akÄ±ÅŸ ÅŸemasÄ±" class="context-image">
                    <h4>Algoritma 2</h4>
                    <img src="resim2.png" alt="Algoritma 2 - NumaralandÄ±rÄ±lmÄ±ÅŸ dÃ¶ngÃ¼ akÄ±ÅŸ ÅŸemasÄ±" class="context-image">
                </div>
                <div class="problem-questions">
                    <h3>DeÄŸerlendirme SÄ±navÄ±</h3>
                    <div class="question-group">
                        <label><span class="point-badge">8 Puan</span> <strong>Soru 1:</strong> Algoritma 2'deki numaralandÄ±rÄ±lmÄ±ÅŸ boÅŸ kutulara algoritmanÄ±n doÄŸru Ã§alÄ±ÅŸmasÄ± iÃ§in hangi ifadeler gelmelidir?</label>
                        <div class="multi-input-container" style="margin-top:15px;">
                            <label for="q1_box1">Kutu 1:</label> <input type="text" id="q1_box1" placeholder="AltÄ±gen">
                            <label for="q1_box2">Kutu 2:</label> <input type="text" id="q1_box2" placeholder="EÅŸkenar DÃ¶rtgen">
                            <label for="q1_box3">Kutu 3:</label> <input type="text" id="q1_box3" placeholder="DalgalÄ± DikdÃ¶rtgen">
                        </div>
                    </div>
                            <div class="question-group">
                                <label for="q2_output"><span class="point-badge">6 Puan</span> <strong>Soru 2:</strong> Algoritma 1'in n deÄŸiÅŸkeninin ilk 5 deÄŸeri (0, 1, 2, 3, 4 ) iÃ§in Ã¼reteceÄŸi ve ekrana yazdÄ±racaÄŸÄ± sonuÃ§larÄ± sÄ±rasÄ±yla, aralarÄ±na virgÃ¼l koyarak yazÄ±nÄ±z.</label>
                        <textarea id="q2_output" rows="2" placeholder="Ã–rn: 10, 11, 12, 13, 14"></textarea>
                    </div>
                    <div class="question-group">
                        <label for="q3_and_logic"><span class="point-badge">6 Puan</span> <strong>Soru 3:</strong> Algoritma 1'de bir sonucun ekrana yazdÄ±rÄ±labilmesi iÃ§in akÄ±ÅŸÄ±n Ã¶nce <span class="math-inline">n < 51 mi?</span> ve sonra <span class="math-inline">sonuÃ§ asal mÄ±?</span> karar bloklarÄ±ndan geÃ§mesi gerekir. Bu durumun gerÃ§ekleÅŸmesi iÃ§in saÄŸlanmasÄ± gereken iki koÅŸulu "ve" baÄŸlacÄ±nÄ± kullanarak tek bir mantÄ±k cÃ¼mlesiyle ifade ediniz.</label>
                         <textarea id="q3_and_logic" rows="3" placeholder="(KoÅŸul 1) ve (KoÅŸul 2) ÅŸeklinde yazÄ±nÄ±z."></textarea>
                    </div>
                    <div class="question-group">
                        <label><span class="point-badge">6 Puan</span> <strong>Soru 4:</strong> AÅŸaÄŸÄ±da, <span class="math-inline">f : N â†’ N</span> ve <span class="math-inline">f(n) = nÂ² + n + 41</span> fonksiyonunu kullanarak 0'dan 50'ye kadar Ã¼retilen asal sayÄ±larÄ±n adedini sayan bir algoritma, doÄŸal dilde eksik adÄ±mlarla verilmiÅŸtir. BoÅŸluklarÄ± doldurunuz.</label>
                        <ul class="blank-fill-list" style="margin-top:15px;">
                            <li class="full-row"><div><strong>AdÄ±m 1:</strong> BaÅŸla.</div></li>
                            <li class="full-row">
                                <div><strong>AdÄ±m 2:</strong> Bir <code>asal_sayac</code> deÄŸiÅŸkeni oluÅŸtur ve baÅŸlangÄ±Ã§ deÄŸerini <input type="text" id="q4_step2" class="inline-input" aria-label="asal_sayac baÅŸlangÄ±Ã§ deÄŸeri"> yap.</div>
                            </li>
                            <li class="full-row"><div><strong>AdÄ±m 3:</strong> <code>n=0</code>'dan <code>50</code>'ye kadar bir dÃ¶ngÃ¼ baÅŸlat.</div></li>
                            <li class="full-row"><div><strong>AdÄ±m 4:</strong> <code>sonuÃ§ = nÂ² + n + 41</code> iÅŸlemini yap.</div></li>
                            <li>
                                <div><strong>AdÄ±m 5:</strong> EÄŸer <code>sonuÃ§</code> asal ise,</div>
                                <div><input type="text" id="q4_step5" class="fill" placeholder="yapÄ±lacak iÅŸlemi yazÄ±nÄ±z."></div>
                            </li>
                            <li>
                                <div><strong>AdÄ±m 6:</strong> DÃ¶ngÃ¼ bittiÄŸinde,</div>
                                <div><input type="text" id="q4_step6" class="fill" placeholder="yapÄ±lacak iÅŸlemi yazÄ±nÄ±z."></div>
                            </li>
                            <li class="full-row"><div><strong>AdÄ±m 7:</strong> Bitir.</div></li>
                        </ul>
                    </div>
                    <div class="question-group">
                        <label for="q5_if_then"><span class="point-badge">4 Puan</span> <strong>Soru 5:</strong> Algoritma 1'de "ise" baÄŸlacÄ±nÄ±n iÅŸlevini tek bir cÃ¼mle ile ifade ediniz.
                        <textarea id="q5_if_then" rows="3" placeholder="EÄŸer sonuÃ§ asal ise, ..."></textarea>
                    </div>
                </div>
            </div>
             <div style="text-align: center; margin-top: 30px;">
                <button class="button" id="finish-exam-btn" onclick="checkAndFinish()">SÄ±navÄ± Bitir ve DeÄŸerlendir</button>
             </div>
        </div>
        
        <!-- DEÄERLENDÄ°RME SAYFASI -->
        <div class="page" id="page-evaluation">
            <h2 style="text-align:center;">DeÄŸerlendirme SonuÃ§larÄ±</h2>
            <p id="evaluation-subtitle" style="text-align:center; margin-top:-10px; margin-bottom:6px; color:var(--secondary-text);">YanÄ±tlarÄ±nÄ±z yapay zeka tarafÄ±ndan analiz ediliyor.</p>
            <div id="scoreCard">
                <div style="font-size: 1rem; opacity: 0.8;">TOPLAM PUAN</div>
                <div id="finalScore" style="font-size: 3rem; font-weight: 700;">-- / 30</div>
                <div id="finalPercentage" style="font-size: 1.2rem; font-weight: 600;">--%</div>
            </div>
            <div id="evaluationContent">
                <div style="text-align: center; padding: 40px 0;">
                    <div class="spinner" role="status"></div>
                    <h4 style="margin-top: 20px;">DeÄŸerlendirme SÃ¼rÃ¼yor...</h4>
                    <div id="aiStatus" style="margin-top:8px; color: var(--secondary-text);"></div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 30px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                <button class="button" onclick="showPage('page-stage1')">â† SÄ±nava DÃ¶n</button>
                <button id="viewSolutionsBtn" class="button" onclick="openSolutionsModal()" style="display:none;">Ã‡Ã¶zÃ¼mleri GÃ¶r</button>
            </div>
        </div>
    </div>

    <!-- Ã‡Ã–ZÃœM MODALI -->
    <div id="solution-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeSolutionsModal()">&times;</span>
            <h2 style="text-align:center;">DetaylÄ± Ã‡Ã¶zÃ¼mler</h2>
            <div id="solutionContent"></div>
        </div>
    </div>

<script>
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const page = document.getElementById(pageId);
        if (page) { page.classList.add('active'); } 
        else { console.error("Sayfa bulunamadÄ±:", pageId); }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const themeToggle = document.getElementById('theme-toggle');
        // Her zaman karanlÄ±k modda baÅŸla
        document.body.classList.add('dark-mode');
        themeToggle.textContent = 'ğŸŒ™';
        localStorage.setItem('theme', 'dark');
        
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const theme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            themeToggle.textContent = theme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
            localStorage.setItem('theme', theme);
        });
        showPage('page-intro');
    });

    // LMS'e puan gÃ¶nderme
    function sendScoreToLMS(ogrenciPuani) {
        const result = {
            score: { max: 30, min: 0, raw: ogrenciPuani, scaled: ogrenciPuani / 30 },
            completion: true,
            success: true,
            duration: 'PT4.95S'
        };
        try {
            const lmsWindow = window.parent.document.getElementById('frmApp-0')?.contentWindow;
            if (lmsWindow?.onCompleted) {
                console.log('ğŸ“¡ LMS\'e veri gÃ¶nderiliyor...');
                lmsWindow.onCompleted(result);
            } else {
                console.error('âŒ LMS\'ye sinyal gÃ¶nderilemedi!');
            }
        } catch (e) {
            console.error('LMS ile iletiÅŸim sÄ±rasÄ±nda hata:', e);
        }
    }

    async function checkAndFinish() {
        const finishBtn = document.getElementById('finish-exam-btn');
        if (finishBtn) finishBtn.disabled = true;

        showPage('page-evaluation');
        let totalScore = 0;

        try {
            if (!navigator.onLine) {
                throw new Error('Ä°nternet baÄŸlantÄ±sÄ± yok. LÃ¼tfen baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
            }
            const userPayload = collectUserResponses();
            const prompt = buildAIScoringPrompt(userPayload);
            const result = await callGemini(prompt);
            const evaluation = formatAIScoringResponse(result);
            const evalContent = document.getElementById('evaluationContent');
            if (evalContent) { evalContent.innerHTML = evaluation.html; }
            const sub = document.getElementById('evaluation-subtitle');
            if (sub) { sub.textContent = 'YanÄ±tlarÄ±nÄ±z yapay zeka tarafÄ±ndan analiz edildi.'; }
            totalScore = evaluation.score || 0;
        } catch (err) {
            console.warn('AI DeÄŸerlendirmesi BaÅŸarÄ±sÄ±z:', err);
            totalScore = runFallbackEvaluation();
        }

        updateAllScoreDisplays(totalScore);

        try { sendScoreToLMS(totalScore); } catch (e) { console.error('LMS gÃ¶nderimi baÅŸarÄ±sÄ±z:', e); }

        populateSolutionModal();
        const solutionsBtn = document.getElementById('viewSolutionsBtn');
        if (solutionsBtn) solutionsBtn.style.display = 'inline-block';
        if (finishBtn) finishBtn.disabled = false;
    }

    async function callGemini(prompt) {
        const apiKey = 'AIzaSyCEhU3erLOAJB9cADTqaGanVidc2DRbhr8'; // Google AI Gemini API anahtarÄ±nÄ±zÄ± buraya girin.
        if (!apiKey || apiKey === 'YOUR_API_KEY') throw new Error('GeÃ§erli bir API anahtarÄ± girilmedi.');

        const models = ['gemini-2.0-flash', 'gemini-2.5-flash', 'gemini-2.5-pro'];
        const timeoutMs = 5000;
        const errors = [];

        try { document.getElementById('aiStatus').textContent = `DeÄŸerlendiriliyor... Denenecek model sÄ±rasÄ±: ${models.join(' â†’ ')}`; } catch (e) {}

        for (const model of models) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
                const body = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body), signal: controller.signal });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    const errorText = await response.text().catch(() => '');
                    errors.push(`${model} -> HTTP ${response.status} ${errorText}`);
                    continue;
                }

                const json = await response.json();
                const text = json?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!text) { errors.push(`${model} -> boÅŸ yanÄ±t`); continue; }
                try { document.getElementById('aiStatus').textContent = ''; } catch (e) {}
                return text;
            } catch (err) {
                clearTimeout(timeoutId);
                errors.push(`${model} -> ${err.message || err}`);
                continue;
            }
        }

        try { document.getElementById('aiStatus').textContent = 'YZ deÄŸerlendirmesi ÅŸu anda kullanÄ±lamÄ±yor; standart deÄŸerlendirme uygulanÄ±yor.'; } catch (e) {}
        throw new Error('TÃ¼m YZ modelleri baÅŸarÄ±sÄ±z oldu: ' + errors.join(' | '));
    }

    function formatAIScoringResponse(raw) {
        let parsed;
        try { parsed = JSON.parse(raw.trim().replace(/^```json\s*|```\s*$/g, '')); }
        catch (e) { throw new Error('YZ yanÄ±tÄ± JSON formatÄ±nda deÄŸil.'); }

        const questions = [
            { id: 'q1', title: 'Soru 1: NumaralÄ± KutularÄ± Doldurma', max: 8 },
            { id: 'q2', title: 'Soru 2: Ä°lk 5 Ã‡Ä±ktÄ±', max: 6 },
            { id: 'q3', title: 'Soru 3: "ve" BaÄŸlacÄ± ile KoÅŸul', max: 6 },
            { id: 'q4', title: 'Soru 4: SayaÃ§ AlgoritmasÄ±nÄ± Tamamlama', max: 6 },
            { id: 'q5', title: 'Soru 5: "ise" BaÄŸlacÄ±nÄ±n Ä°ÅŸlevi', max: 4 }
        ];

        let html = '';
        questions.forEach((q) => {
            const data = parsed[q.id];
            if (data) {
                const puan = Number(data.puan) || 0;
                const aciklama = data.aÃ§Ä±klama || data.aciklama || 'AÃ§Ä±klama mevcut deÄŸil.';
                html += createEvalCard(q.title, puan, q.max, aciklama);
            }
        });

        return { html, score: parsed.toplam_puan || 0 };
    }

    function collectUserResponses() {
        const safeGet = id => (document.getElementById(id) ? document.getElementById(id).value : '');
        return {
            q1: { box1: safeGet('q1_box1'), box2: safeGet('q1_box2'), box3: safeGet('q1_box3') },
            q2: { output: safeGet('q2_output') },
            q3: { and_logic: safeGet('q3_and_logic') },
            q4: { step2: safeGet('q4_step2'), step5: safeGet('q4_step5'), step6: safeGet('q4_step6') },
            q5: { if_then: safeGet('q5_if_then') }
        };
    }

    function buildAIScoringPrompt(data) {
        return `UZMAN DEÄERLENDÄ°RME Ä°STEÄÄ° (RUBRÄ°K TABANLI)\n\nGÃ–REV: AÅŸaÄŸÄ±daki 5 soruluk sÄ±navÄ±, uzman bir bilgisayar bilimi/matematik Ã¶ÄŸretmeni titizliÄŸinde, rubrik esaslÄ± ve tutarlÄ± ÅŸekilde deÄŸerlendir. SADECE JSON Ã§Ä±ktÄ±sÄ± Ã¼ret.\n\nDOÄRU CEVAPLAR (KÄ±sa Referans):\n- S1: Kutu1: n = 0, 50, 1 (veya 0'dan 50'ye 1'er artan dÃ¶ngÃ¼). Kutu2: sonuÃ§ (n^2+n+41) asal mÄ±? Kutu3: sonucu yazdÄ±r (print).\n- S2: 41, 43, 47, 53, 61\n- S3: (n < 51) ve (sonuÃ§ asal)\n- S4: step2=0; step5: asal_sayac 1 artÄ±r; step6: asal_sayac'Ä± yazdÄ±r.\n- S5: "EÄŸer sonuÃ§ asal ise, sonucu yazdÄ±r." (yalnÄ±zca Algoritma 1)\n\nRUBRÄ°K VE PUANLAMA KURALLARI:\n- Ã‡IKTI SADECE JSON olsun. q1..q5, her biri {puan: <soru_max>, aÃ§Ä±klama: "kÄ±sa gerekÃ§e"}. Ek olarak toplam_puan: 0-30.\n\nSORU PUAN DAÄILIMI:\n- Soru 1 â€“ 8 puan: Kutu1 (dÃ¶ngÃ¼ aralÄ±ÄŸÄ± + artÄ±ÅŸ) 4 puan; Kutu2 (asal kontrol) 2 puan; Kutu3 (Ã§Ä±ktÄ±) 2 puan.\n- Soru 2 â€“ 6 puan: Her doÄŸru sayÄ± 1 puan (5 puan); sÄ±ra ve biÃ§im (virgÃ¼lle ayrÄ±k) doÄŸruysa +1 puan.\n- Soru 3 â€“ 6 puan: 've' baÄŸlacÄ±nÄ± doÄŸru kullanÄ±rsa 2 puan; 'n < 51' veya eÅŸdeÄŸeri 2 puan; 'sonuÃ§ asal' 2 puan.\n- Soru 4 â€“ 6 puan: step2=0 (2p), step5 sayaÃ§ artÄ±r (2p), step6 sayaÃ§ yazdÄ±r (2p).\n- Soru 5 â€“ 4 puan: 'EÄŸer ... ise' yapÄ±sÄ± (1p) + 'sonuÃ§' ve 'asal'Ä± belirtme (1p) + eylem: 'yazdÄ±r' (2p).\n\nÃ–ÄŸrencinin yanÄ±tlarÄ±: ${JSON.stringify(data)}\n\nYALNIZCA ÅU ÅEKÄ°LDE JSON DÃ–N:\n{\n    "q1": {"puan": 0, "aÃ§Ä±klama": ""},\n    "q2": {"puan": 0, "aÃ§Ä±klama": ""},\n    "q3": {"puan": 0, "aÃ§Ä±klama": ""},\n    "q4": {"puan": 0, "aÃ§Ä±klama": ""},\n    "q5": {"puan": 0, "aÃ§Ä±klama": ""},\n    "toplam_puan": 0\n}`;
    }

    function runFallbackEvaluation() {
        const sub = document.getElementById('evaluation-subtitle');
        if (sub) sub.textContent = 'Yapay zeka deÄŸerlendirmesi baÅŸarÄ±sÄ±z oldu. Standart deÄŸerlendirme yapÄ±ldÄ±.';

        const user = collectUserResponses();
        let score = 0;
        let feedbackHTML = '';

        function escapeHtml(str) { return String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }
        function createCard(title, pts, max, body) { return createEvalCard(title, pts, max, body); }

        const KEY = {
            print: [
                'yazdÄ±r','yazdir','yaz','ekrana yaz','ekrana bas','ekrana Ã§Ä±ktÄ± ver','ekrana cikti ver',
                'Ã§Ä±ktÄ± ver','cikti ver','gÃ¶ster','goster','konsola yaz','console.log','print','output'
            ],
            prime: [
                'asal','asal sayÄ±','asal sayi','asal mÄ±','asal mi','prime','primal','primality','asal kontrol','asal kontrolÃ¼','asal kontrolu'
            ],
            loopWords: [
                'dÃ¶ngÃ¼','dongu','for','while','do while','tekrarla','tekrar et','iterate','gez',
                'n =','n=','0\'dan 50\'ye','0 den 50 ye','1\'den 50\'ye','1 den 50 ye','0-50','1-50','0..50','1..50','artan','1 er art','1er art','++','+= 1'
            ],
            and: [' ve ','&&','and','âˆ§']
        };
        const REGEX = {
            loopN: [
                /n\s*=\s*0\s*[,â€“\-]?\s*50\s*[,;]?\s*1/i,              // n = 0, 50, 1
                /n\s*=\s*1\s*[,â€“\-]?\s*50\s*[,;]?\s*1/i,               // n = 1, 50, 1 (eski varyasyonlarÄ± da yakala)
                /for\s*\(?\s*n\s*=\s*0.*50\s*\)?/i,                    // for n = 0 ... 50
                /for\s*\(?\s*n\s*=\s*1.*50\s*\)?/i,                    // for n = 1 ... 50
                /0\s*'?dan\s*50\s*'?ye.*(art|\+\+|1'er|1\s*er)/i,       // 0'dan 50'ye ... art
                /1\s*'?den\s*50\s*'?ye.*(art|\+\+|1'er|1\s*er)/i,       // 1'den 50'ye ... art (eski varyasyon)
                /n\s*[<â‰¤]\s*51/i,                                          // n < 51
                /n\s*<=\s*50/i,                                            // n <= 50
                /n\s*in\s*\(?0\s*\.\.\s*50\)?/i,                      // n in 0..50
                /n\s*in\s*\(?1\s*\.\.\s*50\)?/i,                      // n in 1..50
                /0\s*[â€“\-]\s*50\s*aras[Ä±i]/i,                            // 0-50 arasÄ±
                /1\s*[â€“\-]\s*50\s*aras[Ä±i]/i                             // 1-50 arasÄ±
            ]
        };
    function containsAny(text, arr) { const t = (text || '').toLowerCase(); return arr.some(k => t.includes(k)); }
    function containsAnd(text) { const t = (text || '').toLowerCase(); return /(^|\W)ve(\W|$)|&&|\band\b|âˆ§/i.test(t); }
        function matchesAnyRegex(text, regs) { const t = String(text || ''); return regs.some(r => r.test(t)); }

        // S1 â€“ 8 puan
        let q1_score = 0;
        const b1 = user.q1.box1 || '';
        const b2 = user.q1.box2 || '';
        const b3 = user.q1.box3 || '';
        // Box1: loop definition
        if (matchesAnyRegex(b1, REGEX.loopN) || (containsAny(b1, KEY.loopWords) && b1.includes('n'))) q1_score += 4;
        // Box2: prime decision on result
        if (containsAny(b2, KEY.prime)) q1_score += 2;
        // Box3: output printing
        if (containsAny(b3, KEY.print)) q1_score += 2;
        score += q1_score;
        feedbackHTML += createCard('Soru 1: NumaralÄ± KutularÄ± Doldurma', q1_score, 8, 'Beklenen: Kutu1 â†’ n = 0, 50, 1; Kutu2 â†’ sonuÃ§ asal mÄ±?; Kutu3 â†’ sonucu yazdÄ±r.');

        // S2 â€“ 6 puan
        let q2_score = 0;
        const expected = ['41','43','47','53','61'];
        const userList = (user.q2.output || '')
            .split(/[;,\s]+/)
            .map(s => s.replace(/[^0-9-]/g,'').trim())
            .filter(Boolean);
        expected.forEach((c, idx) => { if (userList.includes(c)) q2_score += 1; });
        // order bonus
        if (userList.length >= 5 && expected.every((v,i)=> userList[i] === v)) q2_score += 1;
        if (q2_score > 6) q2_score = 6;
        score += q2_score;
        feedbackHTML += createCard('Soru 2: Ä°lk 5 Ã‡Ä±ktÄ±', q2_score, 6, `DoÄŸru: 41, 43, 47, 53, 61. CevabÄ±nÄ±z: ${escapeHtml(user.q2.output)}`);

        // S3 â€“ 6 puan
        let q3_score = 0;
        const q3 = (user.q3.and_logic || '').toLowerCase();
    if (containsAnd(q3) || containsAny(q3, KEY.and)) q3_score += 2;
    if (/n\s*[<â‰¤]\s*51|n\s*<=\s*50/.test(q3)) q3_score += 2;
        if (containsAny(q3, KEY.prime)) q3_score += 2;
        score += q3_score;
        feedbackHTML += createCard('Soru 3: "ve" BaÄŸlacÄ± ile KoÅŸul', q3_score, 6, 'DoÄŸru: (n < 51) ve (sonuÃ§ asal).');

    // S4 â€“ 6 puan
        let q4_score = 0;
        const s2 = (user.q4.step2 || '').trim();
        const s5 = (user.q4.step5 || '').toLowerCase();
        const s6 = (user.q4.step6 || '').toLowerCase();
    if (s2 === '0' || /sÄ±fÄ±r|0/.test(s2)) q4_score += 2;
    if ((s5.includes('sayac') || s5.includes('sayaÃ§')) && (/(art(t)?Ä±r|artir|arttir)/.test(s5) || s5.includes('++') || /\+=\s*1/.test(s5) || /(1\s*(ekle|arttÄ±r|artÄ±r|artir|arttir|increase))/.test(s5))) q4_score += 2;
    if ((s6.includes('sayac') || s6.includes('sayaÃ§')) && containsAny(s6, KEY.print)) q4_score += 2;
        score += q4_score;
    feedbackHTML += createCard('Soru 4: SayaÃ§ AlgoritmasÄ±nÄ± Tamamlama', q4_score, 6, 'Beklenen: BaÅŸlangÄ±Ã§ 0; asal ise sayaÃ§ 1 art; dÃ¶ngÃ¼ bitince sayaÃ§ yazdÄ±r.');

    // S5 â€“ 4 puan (yalnÄ±zca Algoritma 1)
    let q5_score = 0;
    const q5 = (user.q5?.if_then || '').toLowerCase();
    if ((q5.includes('eÄŸer') && q5.includes('ise')) || (/\bif\b.*\bthen\b/.test(q5)) || /(olursa|halinde|durumunda|koÅŸul saÄŸlanÄ±rsa|kosul saglanirsa)/.test(q5)) q5_score += 1; // if-then benzeri yapÄ±
    if (q5.includes('sonuÃ§') && q5.includes('asal')) q5_score += 1; // koÅŸul
    const actionPrint = containsAny(q5, KEY.print); // yalnÄ±z yazdÄ±r kabul
    if (actionPrint) q5_score += 2;
    if (q5_score > 4) q5_score = 4;
    score += q5_score;
    feedbackHTML += createCard('Soru 5: "ise" BaÄŸlacÄ±nÄ±n Ä°ÅŸlevi', q5_score, 4, 'Ã–rnek doÄŸru cÃ¼mle: "EÄŸer sonuÃ§ asal ise, sonucu yazdÄ±r." (Algoritma 1).');

        const evalContent = document.getElementById('evaluationContent');
        if (evalContent) evalContent.innerHTML = feedbackHTML;
        return score;
    }

    function populateSolutionModal() {
        const el = document.getElementById('solutionContent');
        if (!el) return;
        el.innerHTML = `
            <div class="answer-block"><h4>Soru 1: NumaralÄ± KutularÄ± Doldurma</h4>
                <ul>
                    <li><strong>Kutu 1 (DÃ¶ngÃ¼):</strong> <code>n = 0, 50, 1</code></li>
                    <li><strong>Kutu 2 (Karar):</strong> <code>sonuÃ§ asal mÄ±?</code></li>
                    <li><strong>Kutu 3 (Ã‡Ä±ktÄ±):</strong> <code>sonucu yazdÄ±r</code>.</li>
                </ul>
            </div>
            <div class="answer-block"><h4>Soru 2: Ä°lk 5 Ã‡Ä±ktÄ±</h4>
                <p><strong>DoÄŸru Ã§Ä±ktÄ±:</strong> <code>41, 43, 47, 53, 61</code>.</p>
            </div>
            <div class="answer-block"><h4>Soru 3: "ve" BaÄŸlacÄ± ile KoÅŸul</h4>
                <p><strong>Ã–rnek ifade:</strong> <span class="math-inline">(n < 51) ve (sonuÃ§ asal)</span>.</p>
            </div>
            <div class="answer-block"><h4>Soru 4: SayaÃ§ AlgoritmasÄ±nÄ± Tamamlama</h4>
                <ul>
                    <li><strong>AdÄ±m 2:</strong> <code>asal_sayac = 0</code></li>
                    <li><strong>AdÄ±m 5:</strong> <code>asal_sayac = asal_sayac + 1</code></li>
                    <li><strong>AdÄ±m 6:</strong> <code>asal_sayac'Ä± yazdÄ±r</code></li>
                </ul>
            </div>
            <div class="answer-block"><h4>Soru 5: "ise" BaÄŸlacÄ±nÄ±n Ä°ÅŸlevi</h4>
                <p><strong>Ã–rnek doÄŸru ifade:</strong> <span class="math-inline">EÄŸer sonuÃ§ asal ise, sonucu yazdÄ±r.</span> (Algoritma 1)</p>
            </div>`;
    }

    // YardÄ±mcÄ±lar
    function createEvalCard(title, score, max, body) {
        const perc = max > 0 ? (score/max)*100 : 0;
        const color = perc >= 99 ? '#22c55e' : (perc >= 50 ? '#f59e0b' : '#ef4444');
        return `<div class="evaluation-card" style="border-left-color: ${color};">
               <div style="display:flex; justify-content:space-between; align-items:center;"><h4>${title}</h4><div style="font-weight:bold;">${Math.round(score)} / ${max} Puan</div></div>
               ${body ? `<div class="evaluation-body" style="margin-top:10px;">${body}</div>` : ''}</div>`;
    }
    function updateAllScoreDisplays(finalScore) {
        const roundedScore = Math.round(finalScore);
        const scorePercentage = (roundedScore / 30) * 100;
        const fs = document.getElementById('finalScore');
        if (fs) fs.textContent = `${roundedScore} / 30`;
        const fp = document.getElementById('finalPercentage');
        if (fp) fp.textContent = `${scorePercentage.toFixed(0)}%`;
        const scoreCard = document.getElementById('scoreCard');
        if (scoreCard) {
            if (scorePercentage >= 80) scoreCard.style.background = 'linear-gradient(135deg, #16a34a, #22c55e)';
            else if (scorePercentage >= 50) scoreCard.style.background = 'linear-gradient(135deg, #f59e0b, #facc15)';
            else scoreCard.style.background = 'linear-gradient(135deg, #dc2626, #ef4444)';
        }
    }
    const solutionModal = document.getElementById('solution-modal');
    function openSolutionsModal() { if(solutionModal) solutionModal.style.display = 'block'; }
    function closeSolutionsModal() { if(solutionModal) solutionModal.style.display = 'none'; }
    window.onclick = function(event) { if (event.target == solutionModal) solutionModal.style.display = 'none'; }
</script>
</body>
</html>