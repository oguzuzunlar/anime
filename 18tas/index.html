<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>18 TaÅŸlÄ± Dama</title>
    <style>
        :root {
            --bg-color: #2c2117; 
            --sidebar-bg: #3d2b1f; 
            --text-color: #f5e6d3;
            --board-bg: #c59830; 
            --line-color: #3d2b1f;
            --stone-red: radial-gradient(circle at 30% 30%, #ff8a80, #e53935 60%, #8e0000);
            --stone-green: radial-gradient(circle at 30% 30%, #a5d6a7, #4caf50 60%, #1b5e20);
            --stone-size: 36px;
            --game-area-grad-1: #3d2b1f;
            --game-area-grad-2: #1a120b;
            --btn-bg: #5d4037;
            --btn-outline-color: var(--board-bg);
            --btn-outline-border: var(--board-bg);
        }

        body[data-theme='light'] {
            --bg-color: #f4eee6;
            --sidebar-bg: #ece0d3;
            --text-color: #2f241b;
            --board-bg: #d6aa48;
            --line-color: #4a3728;
            --game-area-grad-1: #e9dbc8;
            --game-area-grad-2: #d9c5ab;
            --btn-bg: #6d4c41;
            --btn-outline-color: #7b3e19;
            --btn-outline-border: #7b3e19;
        }

        body[data-theme='dark'] {
            --bg-color: #2c2117;
            --sidebar-bg: #3d2b1f;
            --text-color: #f5e6d3;
            --board-bg: #c59830;
            --line-color: #3d2b1f;
            --game-area-grad-1: #3d2b1f;
            --game-area-grad-2: #1a120b;
            --btn-bg: #5d4037;
            --btn-outline-color: var(--board-bg);
            --btn-outline-border: var(--board-bg);
        }

        body {
            margin: 0; padding: 0; display: flex; height: 100vh;
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            transition: background 0.3s; overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        #main-wrapper { display: flex; width: 100%; height: 100%; }

        #sidebar {
            width: 300px; background-color: var(--sidebar-bg); padding: 25px;
            box-shadow: 2px 0 15px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; gap: 12px; z-index: 10;
        }

        h1 { margin: 0; color: var(--board-bg); font-size: 20px; text-transform: uppercase; letter-spacing: 2px; text-align: center; border-bottom: 2px solid #5d4037; padding-bottom: 10px; }

        .panel { background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }

        .status-bar {
            font-size: 1rem; font-weight: bold; text-align: center;
            padding: 10px; background: #f5e6d3; color: #3d2b1f; border-radius: 6px;
        }

        select, button { padding: 10px; border-radius: 6px; border: none; background: var(--btn-bg); color: white; cursor: pointer; font-weight: bold; font-family: inherit; }
        button.primary { background: #e53935; color: white; }
        button.outline { background: transparent; border: 2px solid var(--btn-outline-border); color: var(--btn-outline-color); }

        #game-area { flex-grow: 1; display: flex; justify-content: center; align-items: center; padding: 20px; background: radial-gradient(circle, var(--game-area-grad-1), var(--game-area-grad-2)); }
        
        #game-board-container { 
            position: relative; width: min(94vw, 850px); aspect-ratio: 1.8 / 1; 
            padding: 10px; background: #8d6e63; border-radius: 15px; box-shadow: 0 20px 50px rgba(0,0,0,0.7);
        }

        #game-board {
            position: absolute; width: calc(100% - 20px); height: calc(100% - 20px);
            left: 10px; top: 10px; background-color: var(--board-bg); 
            border-radius: 10px; overflow: hidden;
            touch-action: manipulation;
        }

        svg { position: absolute; width: 100%; height: 100%; pointer-events: none; }
        
        .node-point {
            position: absolute; width: 11px; height: 11px;
            background: rgba(20,10,5,0.55);
            border: 2px solid rgba(255,255,255,0.45);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 1px 4px rgba(0,0,0,0.4);
            z-index: 5;
        }

        .node-hitbox { position: absolute; width: 50px; height: 50px; transform: translate(-50%, -50%); cursor: pointer; z-index: 30; }

        .hint {
            position: absolute; width: 22px; height: 22px;
            background: rgba(255, 255, 255, 0.4); border-radius: 50%;
            transform: translate(-50%, -50%); z-index: 15;
            animation: pulse 0.6s infinite alternate; border: 2px solid white;
        }
        @keyframes pulse { from { opacity: 0.2; scale: 0.8; } to { opacity: 0.9; scale: 1.2; } }

        .stone {
            position: absolute; width: var(--stone-size); height: var(--stone-size);
            border-radius: 50%; transform: translate(-50%, -50%);
            z-index: 20; pointer-events: none;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 8px 12px rgba(0,0,0,0.5);
        }
        .stone.red { background: var(--stone-red); }
        .stone.green { background: var(--stone-green); }
        .stone.selected { box-shadow: 0 0 20px 8px white; z-index: 25; scale: 1.1; }

        /* SÄ±ra gÃ¶stergesi â€“ tahta kenarÄ± parlamasÄ± */
        #game-board-container { transition: box-shadow 0.4s ease; }
        #game-board-container.turn-red {
            box-shadow: 0 20px 50px rgba(0,0,0,0.7), 0 0 0 4px #e53935, 0 0 28px 8px rgba(229,57,53,0.55);
        }
        #game-board-container.turn-green {
            box-shadow: 0 20px 50px rgba(0,0,0,0.7), 0 0 0 4px #43a047, 0 0 28px 8px rgba(67,160,71,0.55);
        }

        /* Status bar mini taÅŸ gÃ¶stergesi */
        .status-bar { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .turn-stone-dot {
            width: 22px; height: 22px; border-radius: 50%; flex-shrink: 0;
            box-shadow: 0 3px 8px rgba(0,0,0,0.5);
            transition: background 0.35s ease, box-shadow 0.35s ease;
        }
        .turn-stone-dot.red   { background: radial-gradient(circle at 30% 30%, #ff8a80, #e53935 60%, #8e0000); box-shadow: 0 3px 10px rgba(229,57,53,0.7); }
        .turn-stone-dot.green { background: radial-gradient(circle at 30% 30%, #a5d6a7, #4caf50 60%, #1b5e20); box-shadow: 0 3px 10px rgba(76,175,80,0.7); }

        #combo-msg { color: #ffeb3b; font-size: 0.8rem; text-align: center; display: none; margin-top: 5px; font-weight: bold; }

        #winner-modal {
            position: fixed;
            inset: 0;
            display: none;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.75);
            z-index: 4000;
            padding: 20px;
            box-sizing: border-box;
        }

        #winner-modal.show { display: flex; }

        .winner-dialog {
            position: relative;
            width: min(460px, 100%);
            background: linear-gradient(145deg, #3e316d, #2c2554);
            border: 2px solid rgba(255,255,255,0.22);
            border-radius: 18px;
            padding: 36px 28px 28px;
            text-align: center;
            box-shadow: 0 24px 60px rgba(0,0,0,0.7);
            color: #fff;
            z-index: 2;
        }

        .winner-trophy { font-size: 3.8rem; margin-bottom: 8px; animation: trophyBounce 0.7s ease; }
        @keyframes trophyBounce {
            0%   { transform: scale(0) rotate(-15deg); opacity: 0; }
            60%  { transform: scale(1.25) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0); }
        }

        .winner-headline {
            margin: 0 0 6px;
            font-size: 1.7rem;
            font-weight: 900;
            letter-spacing: 2px;
            text-shadow: 0 2px 12px rgba(0,0,0,0.5);
        }
        .winner-headline.red-win   { color: #ff8a80; }
        .winner-headline.green-win { color: #a5d6a7; }
        .winner-headline.ai-win    { color: #ef9a9a; }

        .winner-sub {
            margin: 0 0 24px;
            font-size: 1.05rem;
            opacity: 0.85;
            line-height: 1.5;
        }

        .winner-actions { display: flex; gap: 12px; justify-content: center; }
        .winner-actions button { flex: 1; max-width: 180px; padding: 12px; font-size: 0.95rem; }

        /* Havai fiÅŸek canvas */
        #fw-canvas {
            position: fixed;
            inset: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 3999;
            display: none;
        }

        #howto-screen {
            position: fixed;
            inset: 0;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 18px;
            box-sizing: border-box;
            background: radial-gradient(circle at top, #4e3d85, #3e316d 50%, #2c2554);
            color: #fff;
        }

        .howto-card {
            width: min(720px, 100%);
            max-height: 92dvh;
            overflow: auto;
            border-radius: 14px;
            padding: 18px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .howto-title {
            margin: 0 0 12px;
            text-align: center;
            font-size: 1.6rem;
            letter-spacing: 1px;
        }

        .howto-sub {
            margin: 0 0 14px;
            text-align: center;
            opacity: 0.9;
            font-size: 0.95rem;
        }

        .howto-list {
            margin: 0;
            padding-left: 22px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            line-height: 1.45;
            font-size: 1rem;
        }

        .howto-actions {
            margin-top: 18px;
            display: flex;
            justify-content: center;
        }

        /* ---- Yatay mod kilidi ---- */
        #landscape-lock {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: #1a0e05;
            color: #f5e6d3;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            text-align: center;
            padding: 30px;
        }
        #landscape-lock.show { display: flex; }
        .lock-icon {
            font-size: 3.5rem;
            animation: rotatePhone 1.5s ease-in-out infinite alternate;
        }
        @keyframes rotatePhone {
            from { transform: rotate(0deg); }
            to   { transform: rotate(-90deg); }
        }
        .lock-text { font-size: 1.15rem; font-weight: bold; line-height: 1.6; }

        /* ---- NasÄ±l oynanÄ±r modal ---- */
        #howto-modal-bg {
            position: fixed;
            inset: 0;
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.72);
            padding: 18px;
            box-sizing: border-box;
            animation: fadeInBg 0.25s ease;
        }
        #howto-modal-bg.show { display: flex; }
        @keyframes fadeInBg { from { opacity: 0; } to { opacity: 1; } }
        .howto-modal-card {
            width: min(680px, 100%);
            max-height: 90dvh;
            overflow-y: auto;
            border-radius: 14px;
            padding: 22px;
            background: linear-gradient(145deg, #3e316d, #2c2554);
            border: 1px solid rgba(255,255,255,0.18);
            color: #fff;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
            animation: slideUp 0.28s cubic-bezier(0.22,1,0.36,1);
        }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px) scale(0.96); } to { opacity: 1; transform: translateY(0) scale(1); } }

        @media (max-width: 900px) {
            :root { --stone-size: 28px; }
            body { flex-direction: column; overflow-y: auto; height: auto; }
            #main-wrapper { flex-direction: column; min-height: 100dvh; }
            #sidebar { width: 100%; order: 2; padding: 14px; box-sizing: border-box; }
            #game-area { order: 1; flex: 0 0 auto; min-height: 66vh; padding: 8px 6px 0; align-items: center; justify-content: center; }
            #game-board-container {
                width: min(92vw, 430px);
                aspect-ratio: 1 / 1.8;
                max-height: 78dvh;
                padding: 10px;
                border-radius: 14px;
                box-shadow: 0 14px 34px rgba(0,0,0,0.58);
            }
            #game-board {
                position: absolute;
                width: calc(100% - 20px);
                height: calc(100% - 20px);
                left: 10px;
                top: 10px;
                transform: none;
            }
            select, button { width: 100%; min-height: 44px; }
            .node-hitbox { width: 54px; height: 54px; }
            .status-bar { font-size: 0.95rem; }
            #winner-title { font-size: 1.1rem; }
            .howto-card { padding: 14px; }
            .howto-title { font-size: 1.25rem; }
            .howto-list { font-size: 0.96rem; }
            .intro-mode-btns, .intro-diff-btns { flex-wrap: wrap; }
            .mode-btn { padding: 10px 16px; font-size: 0.95rem; }
        }

        /* ---- AÃ§Ä±lÄ±ÅŸ ekranÄ± mod seÃ§imi ---- */
        .intro-section-label {
            text-align: center;
            font-size: 0.8rem;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            opacity: 0.65;
            margin: 16px 0 8px;
        }
        .intro-mode-btns, .intro-diff-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 6px;
        }
        .mode-btn {
            padding: 11px 26px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.25);
            background: rgba(255,255,255,0.08);
            color: #fff;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .mode-btn.active {
            background: #e53935;
            border-color: #e53935;
            box-shadow: 0 0 14px rgba(229,57,53,0.45);
        }
        .mode-btn:hover:not(.active) { background: rgba(255,255,255,0.18); }
        .diff-btn {
            padding: 8px 20px;
            border-radius: 6px;
            border: 2px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.07);
            color: #fff;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .diff-btn.active {
            background: #5c6bc0;
            border-color: #7986cb;
            box-shadow: 0 0 10px rgba(92,107,192,0.4);
        }
        .diff-btn:hover:not(.active) { background: rgba(255,255,255,0.14); }
        .intro-divider {
            border: none;
            border-top: 1px solid rgba(255,255,255,0.12);
            margin: 16px 0;
        }
        .menu-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 6px;
        }
        .menu-info-item {
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.12);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.88rem;
            line-height: 1.5;
        }
        @media (max-width: 480px) {
            .menu-info-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <!-- Yatay mod uyarÄ± ekranÄ± -->
    <div id="landscape-lock">
        <div class="lock-icon">ğŸ“±</div>
        <div class="lock-text">LÃ¼tfen cihazÄ±nÄ±zÄ±<br><strong>dikey konuma</strong> dÃ¶ndÃ¼rÃ¼n.<br>Oyun yatay modda Ã§alÄ±ÅŸmaz.</div>
    </div>

    <!-- AÃ§Ä±lÄ±ÅŸ howto ekranÄ± -->
    <div id="howto-screen" role="dialog" aria-modal="true" aria-labelledby="howto-title">
        <div class="howto-card">
            <h2 id="howto-title" class="howto-title">18 TaÅŸlÄ± Dama</h2>

            <!-- Oyun modu seÃ§imi -->
            <p class="intro-section-label">Oyun Modu</p>
            <div class="intro-mode-btns">
                <button class="mode-btn" data-mode="pvp" onclick="selectIntroMode('pvp')">ğŸ‘¥ Ä°ki KiÅŸi</button>
                <button class="mode-btn active" data-mode="pve" onclick="selectIntroMode('pve')">ğŸ¤– Bilgisayara KarÅŸÄ±</button>
            </div>
            <div id="intro-diff-wrap" style="display:block; text-align:center;">
                <p class="intro-section-label" style="margin-top:10px;">Zorluk Seviyesi</p>
                <div class="intro-diff-btns">
                    <button class="diff-btn" data-level="easy" onclick="selectIntroDiff('easy')">Kolay</button>
                    <button class="diff-btn active" data-level="medium" onclick="selectIntroDiff('medium')">Orta</button>
                    <button class="diff-btn" data-level="hard" onclick="selectIntroDiff('hard')">Zor</button>
                </div>
            </div>

            <div class="howto-actions" style="margin-top:16px;">
                <button class="primary" style="width:100%; padding:13px; font-size:1.05rem; letter-spacing:1px;" onclick="closeHowToScreen()">â–¶ OYUNA BAÅLA</button>
            </div>

            <hr class="intro-divider">

            <!-- Oyun kurallarÄ± -->
            <p class="howto-sub" style="margin-bottom:10px;">NasÄ±l OynanÄ±r?</p>
            <ul class="howto-list">
                <li><strong>Hamle yapmak:</strong> Oyuncular sÄ±rayla oynar. Ã–nce kendi taÅŸlarÄ±ndan birine tÄ±klarsÄ±nÄ±z, sonra taÅŸÄ±n gidebileceÄŸi komÅŸu boÅŸ noktayÄ± seÃ§ersiniz. TaÅŸlar yalnÄ±zca Ã§izgiler Ã¼zerinde ilerleyebilir.</li>
                <li><strong>Rakip taÅŸÄ± almak:</strong> Bir rakip taÅŸÄ±nÄ±n tam karÅŸÄ±sÄ±ndaki nokta boÅŸsa, o taÅŸÄ±n Ã¼zerinden sÄ±Ã§rayarak o noktaya geÃ§ebilirsiniz. Ãœzerinden atlanarak alÄ±nan taÅŸ oyundan Ã§Ä±kar. TaÅŸÄ± almak zorunda deÄŸilsiniz, seÃ§im size ait.</li>
                <li><strong>Kombo:</strong> TaÅŸ aldÄ±ktan sonra aynÄ± taÅŸla zincirleme alma fÄ±rsatÄ± Ã§Ä±karsa, sÄ±ra sizde kalmak Ã¼zere komboyu sÃ¼rdÃ¼rebilirsiniz. Kombo sona erince sÄ±ra rakibe geÃ§er.</li>
                <li><strong>Kazanma koÅŸulu:</strong> Rakibinin 18 taÅŸÄ±nÄ±n tamamÄ±nÄ± tahtadan kaldÄ±ran oyuncu oyunu kazanÄ±r.</li>
            </ul>

            <hr class="intro-divider">

            <!-- MenÃ¼ aÃ§Ä±klamalarÄ± -->
            <p class="howto-sub" style="margin-bottom:10px;">MenÃ¼ ButonlarÄ±</p>
            <div class="menu-info-grid">
                <div class="menu-info-item">ğŸ”´ <strong>Oyun Modu</strong><br>Ä°ki kiÅŸi veya bilgisayara karÅŸÄ± oynama seÃ§eneÄŸini belirler.</div>
                <div class="menu-info-item">âš™ï¸ <strong>Zorluk</strong><br>Bilgisayara karÅŸÄ± oynarken yapay zekanÄ±n seviyesini ayarlar: Kolay, Orta veya Zor.</div>
                <div class="menu-info-item">ğŸ”„ <strong>Yeni Oyun</strong><br>TahtayÄ± sÄ±fÄ±rlayarak seÃ§ili modda yeni bir oyun baÅŸlatÄ±r.</div>
                <div class="menu-info-item">â˜€ï¸ğŸŒ™ <strong>Tema</strong><br>ArayÃ¼zÃ¼ aÃ§Ä±k (gÃ¼ndÃ¼z) veya koyu (gece) modda gÃ¶rÃ¼ntÃ¼ler.</div>
                <div class="menu-info-item">ğŸµ <strong>MÃ¼zik</strong><br>Arka planda Ã§alan oyun mÃ¼ziÄŸini aÃ§ar ya da kapatÄ±r.</div>
                <div class="menu-info-item">â“ <strong>NasÄ±l OynanÄ±r</strong><br>Bu kural ekranÄ±nÄ± istediÄŸin zaman yeniden aÃ§mana yarar.</div>
            </div>

        </div>
    </div>

    <!-- NasÄ±l oynanÄ±r modal (panel butonu) -->
    <div id="howto-modal-bg" role="dialog" aria-modal="true" onclick="closeHowtoModal(event)">
        <div class="howto-modal-card" onclick="event.stopPropagation()">
            <h2 class="howto-title" style="margin:0 0 12px; text-align:center; font-size:1.45rem;">18 TaÅŸlÄ± Dama</h2>

            <p class="howto-sub" style="margin-bottom:10px;">NasÄ±l OynanÄ±r?</p>
            <ul class="howto-list">
                <li><strong>Hamle yapmak:</strong> Oyuncular sÄ±rayla oynar. Ã–nce kendi taÅŸlarÄ±ndan birine tÄ±kla, sonra taÅŸÄ±n gidebileceÄŸi komÅŸu boÅŸ noktayÄ± seÃ§. TaÅŸlar yalnÄ±zca Ã§izgiler Ã¼zerinde ilerleyebilir.</li>
                <li><strong>Rakip taÅŸÄ± almak:</strong> Bir rakip taÅŸÄ±nÄ±n tam karÅŸÄ±sÄ±ndaki nokta boÅŸsa, o taÅŸÄ±n Ã¼zerinden sÄ±Ã§rayarak o noktaya geÃ§ebilirsin. Ãœzerinden atlanan taÅŸlar oyundan Ã§Ä±kar. TaÅŸlarÄ±n Ã¼zerinden atlamak zorunlu deÄŸil, seÃ§im sana ait.</li>
                <li><strong>Kombo:</strong> TaÅŸ aldÄ±ktan sonra aynÄ± taÅŸla zincirleme alma fÄ±rsatÄ± Ã§Ä±karsa, sÄ±ra sende kalmak Ã¼zere komboyu sÃ¼rdÃ¼rebilirsin. Kombo sona erince sÄ±ra rakibe geÃ§er.</li>
                <li><strong>Kazanma koÅŸulu:</strong> Rakibinin 18 taÅŸÄ±nÄ±n tamamÄ±nÄ± tahtadan kaldÄ±ran oyuncu oyunu kazanÄ±r.</li>
            </ul>

            <hr class="intro-divider">

            <p class="howto-sub" style="margin-bottom:10px;">MenÃ¼ ButonlarÄ±</p>
            <div class="menu-info-grid">
                <div class="menu-info-item">ğŸ”´ <strong>Oyun Modu</strong><br>Ä°ki kiÅŸi veya bilgisayara karÅŸÄ± oynama seÃ§eneÄŸini belirler.</div>
                <div class="menu-info-item">âš™ï¸ <strong>Zorluk</strong><br>Bilgisayara karÅŸÄ± oynarken yapay zekanÄ±n seviyesini ayarlar: Kolay, Orta veya Zor.</div>
                <div class="menu-info-item">ğŸ”„ <strong>Yeni Oyun</strong><br>TahtayÄ± sÄ±fÄ±rlayarak seÃ§ili modda yeni bir oyun baÅŸlatÄ±r.</div>
                <div class="menu-info-item">â˜€ï¸ğŸŒ™ <strong>Tema</strong><br>ArayÃ¼zÃ¼ aÃ§Ä±k (gÃ¼ndÃ¼z) veya koyu (gece) modda gÃ¶rÃ¼ntÃ¼ler.</div>
                <div class="menu-info-item">ğŸµ <strong>MÃ¼zik</strong><br>Arka planda Ã§alan oyun mÃ¼ziÄŸini aÃ§ar ya da kapatÄ±r.</div>
                <div class="menu-info-item">â“ <strong>NasÄ±l OynanÄ±r</strong><br>Bu kural ekranÄ±nÄ± istediÄŸin zaman yeniden aÃ§mana yarar.</div>
            </div>

            <div class="howto-actions">
                <button class="primary" onclick="closeHowtoModal()">TAMAM</button>
            </div>
        </div>
    </div>

    <div id="main-wrapper">
        <div id="sidebar">
            <h1>18 TAÅLI DAMA</h1>
            <div id="status" class="status-bar">
                <span id="turn-stone" class="turn-stone-dot red"></span>
                SÄ±ra: <span id="turn-txt">KÄ±rmÄ±zÄ±</span>
            </div>
            <div id="combo-msg">âš¡ KOMBO DEVAM EDÄ°YOR!</div>

            <div class="panel">
                <div id="score" style="text-align: center; font-weight: bold; color: #fff;">
                    KÄ±rmÄ±zÄ±: 18 | YeÅŸil: 18
                </div>
            </div>

            <div class="panel" style="display:flex; flex-direction:column; gap:8px;">
                <button class="primary" onclick="openIntroScreen()">YENÄ° OYUN</button>
                <button class="outline" onclick="toggleTheme()" id="themeBtn">â˜€ï¸ GÃœNDÃœZ</button>
                <button class="outline" onclick="toggleMusic()" id="musicBtn">ğŸµ MÃœZÄ°K AÃ‡</button>
                <button class="outline" onclick="openHowtoModal()">â“ NASIL OYNANIR</button>
            </div>
        </div>

        <div id="game-area">
            <div id="game-board-container">
                <div id="game-board">
                    <svg id="svg-layer"></svg>
                    <div id="elements-layer"></div>
                </div>
            </div>
        </div>
    </div>

    <canvas id="fw-canvas"></canvas>

    <div id="winner-modal" role="dialog" aria-modal="true" aria-labelledby="winner-title">
        <div class="winner-dialog">
            <div class="winner-trophy" id="winner-trophy">ğŸ†</div>
            <h2 id="winner-title" class="winner-headline">KAZANDINIZ!</h2>
            <p id="winner-sub" class="winner-sub">Tebrikler!</p>
            <div class="winner-actions">
                <button class="primary" onclick="closeWinnerAndGoIntro()">&#x21BA; TEKRAR OYNA</button>
            </div>
        </div>
    </div>

<script>
    const svgLayer = document.getElementById('svg-layer');
    const nodesLayer = document.getElementById('elements-layer');
    const winnerModal = document.getElementById('winner-modal');
    const winnerTitle = document.getElementById('winner-title');
    const howToScreen = document.getElementById('howto-screen');
    const musicBtn = document.getElementById('musicBtn');
    let nodes = [];
    let adj = {};
    let state = { board: {}, turn: 'red', selected: null, isCombo: false, score: { red: 18, green: 18 }, mode: 'pvp', aiLevel: 'medium', gameOver: false };

    const introPlaylist = [
        'intro.mp3'
    ];

    const gamePlaylist = [
        'bgm-1.mp3'
    ];

    const audioState = {
        enabled: true,
        screen: 'intro',
        trackIndex: 0,
        bgm: new Audio(),
        sfx: {
            move:    new Audio('move.mp3'),
            capture: new Audio('capture.mp3'),
            win:     new Audio('win.mp3'),
            click:   new Audio('click.mp3'),
            applause: new Audio('applause.mp3')
        }
    };

    // OKLA GÃ–STERDÄ°ÄÄ°NÄ°Z VE SÄ°STEMDEN Ã‡IKARILAN NOKTALAR
    const disabledNodes = [1, 7, 9, 17, 27, 35, 37, 43];

    const W = 850, H = 472, stepX = 90, stepY = 85, startX = 65, startY = 55;
    const drawnMainLinks = [
        [0, 36], [0, 20], [2, 38], [2, 42], [2, 6], [3, 39], [4, 24], [4, 20], [4, 40], [5, 41],
        [6, 42], [6, 38], [8, 44], [8, 24], [10, 28], [11, 15], [16, 34], [20, 36], [20, 40],
        [20, 24], [24, 44], [24, 40], [29, 33], [38, 42], [18, 20], [24, 26]
    ];

    function gcd(a, b) { return b ? gcd(b, a % b) : a; }

    function setupAudio() {
        audioState.bgm.volume = 0.35;
        audioState.bgm.loop = false;
        audioState.bgm.preload = 'auto';
        audioState.bgm.addEventListener('ended', () => {
            if (audioState.screen === 'intro') {
                // GiriÅŸ mÃ¼ziÄŸi bitti â†’ baÅŸa dÃ¶n
                loadBgm('intro', 0);
                tryPlay();
            } else {
                // Oyun mÃ¼ziÄŸi bitti â†’ sÄ±radaki parÃ§a
                const next = (audioState.trackIndex + 1) % gamePlaylist.length;
                loadBgm('game', next);
                tryPlay();
            }
        });

        Object.values(audioState.sfx).forEach(s => {
            s.volume = 0.55;
            s.preload = 'auto';
        });

        // Butonlarda global click sesi
        document.addEventListener('click', e => {
            if (e.target.closest('button') && audioState.enabled) playSfx('click');
        }, true);

        loadBgm('intro', 0);
        tryPlay();              // TarayÄ±cÄ± izin verirse hemen baÅŸlat
        updateMusicUI();
    }

    function loadBgm(screen, index) {
        audioState.screen = screen;
        audioState.trackIndex = index;
        const src = screen === 'intro'
            ? introPlaylist[index % introPlaylist.length]
            : gamePlaylist[index % gamePlaylist.length];
        audioState.bgm.loop = (screen === 'game'); // oyun mÃ¼ziÄŸi sÃ¼rekli dÃ¶nÃ¼sÃ¼n
        audioState.bgm.src = src;
        audioState.bgm.load();
    }

    function tryPlay() {
        if (!audioState.enabled) return;
        audioState.bgm.play().then(() => {
            // BaÅŸarÄ±lÄ± â€“ autoplay izni verildi
        }).catch(() => {
            // TarayÄ±cÄ± engeli â€“ ilk etkileÅŸim bekleniyor
            const unlock = () => {
                if (audioState.enabled) {
                    audioState.bgm.play().catch(() => {});
                }
                ['pointerdown', 'touchstart', 'keydown'].forEach(ev =>
                    window.removeEventListener(ev, unlock));
            };
            ['pointerdown', 'touchstart', 'keydown'].forEach(ev =>
                window.addEventListener(ev, unlock, { once: true }));
        });
    }

    function switchToBgm(screen) {
        const wasPlaying = !audioState.bgm.paused;
        loadBgm(screen, 0);
        if (audioState.enabled) tryPlay();
    }

    function playBgm() { tryPlay(); }

    function toggleMusic() {
        audioState.enabled = !audioState.enabled;
        if (audioState.enabled) {
            tryPlay();
        } else {
            audioState.bgm.pause();
        }
        updateMusicUI();
    }

    function nextTrack(autoPlay = false) {
        const next = audioState.screen === 'intro' ? 0
            : (audioState.trackIndex + 1) % gamePlaylist.length;
        loadBgm(audioState.screen, next);
        if (autoPlay || audioState.enabled) tryPlay();
        updateMusicUI();
    }

    function playSfx(type) {
        const sound = audioState.sfx[type];
        if (!sound) return;
        sound.currentTime = 0;
        sound.play().catch(() => {});
    }

    function updateMusicUI(overrideLabel = '') {
        if (!musicBtn) return;
        if (overrideLabel) { musicBtn.innerText = `ğŸµ ${overrideLabel}`; return; }
        musicBtn.innerText = audioState.enabled ? 'ğŸ”‡ MÃœZÄ°K KAPAT' : 'ğŸµ MÃœZÄ°K AÃ‡';
    }

    function addNode(id, x, y) {
        if (disabledNodes.includes(id)) return;
        nodes[id] = { id, x, y };
        adj[id] = [];
    }

    // Ã‡izgi parÃ§alama mantÄ±ÄŸÄ±: Devre dÄ±ÅŸÄ± bÄ±rakÄ±lan noktalarÄ± atlayarak baÄŸlar
    function addPath(u, v) {
        const r1 = Math.floor(u / 9), c1 = u % 9;
        const r2 = Math.floor(v / 9), c2 = v % 9;
        const dr = r2 - r1, dc = c2 - c1;
        const steps = gcd(Math.abs(dr), Math.abs(dc));
        const sr = dr / steps, sc = dc / steps;

        let lastValid = u;
        for (let i = 1; i <= steps; i++) {
            const nextId = (r1 + i * sr) * 9 + (c1 + i * sc);
            if (!disabledNodes.includes(nextId)) {
                link(lastValid, nextId);
                lastValid = nextId;
            }
        }
    }

    function link(u, v) {
        if (disabledNodes.includes(u) || disabledNodes.includes(v)) return;
        if (!adj[u]) adj[u] = []; if (!adj[v]) adj[v] = [];
        if (!adj[u].includes(v)) adj[u].push(v);
        if (!adj[v].includes(u)) adj[v].push(u);
    }

    function isMobilePortraitBoard() {
        return window.matchMedia('(max-width: 900px)').matches;
    }

    function mapCoords(x, y) {
        if (!isMobilePortraitBoard()) {
            return { px: (x / W) * 100, py: (y / H) * 100 };
        }
        return { px: (y / H) * 100, py: ((W - x) / W) * 100 };
    }

    function getRawCoordById(id) {
        return { x: startX + (id % 9) * stepX, y: startY + Math.floor(id / 9) * stepY };
    }

    function drawBoardLines() {
        svgLayer.innerHTML = '';
        drawnMainLinks.forEach(l => {
            const start = getRawCoordById(l[0]);
            const end = getRawCoordById(l[1]);
            const s = mapCoords(start.x, start.y);
            const e = mapCoords(end.x, end.y);

            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', s.px + '%');
            line.setAttribute('y1', s.py + '%');
            line.setAttribute('x2', e.px + '%');
            line.setAttribute('y2', e.py + '%');
            line.setAttribute('stroke', 'var(--line-color)');
            line.setAttribute('stroke-width', isMobilePortraitBoard() ? '2.6' : '3');
            line.setAttribute('stroke-linecap', 'round');
            svgLayer.appendChild(line);
        });
    }

    function buildGraph() {
        nodes = []; adj = {};
        for (let r = 0; r < 5; r++) {
            for (let c = 0; c < 9; c++) addNode(r * 9 + c, startX + c * stepX, startY + r * stepY);
        }

        drawnMainLinks.forEach(l => addPath(l[0], l[1]));
        drawBoardLines();
    }

    function initGame() {
        state.board = {}; state.gameOver = false; state.turn = 'red'; state.selected = null; state.isCombo = false;
        state.score = { red: 18, green: 18 };
        state.mode = introMode;
        state.aiLevel = introDiff;
        hideWinnerModal();

        // VERDÄ°ÄÄ°NÄ°Z 18 + 18 TAÅ DÄ°ZÄ°LÄ°MÄ°
        const yellowNodes = [8, 26, 44, 16, 25, 34, 24, 6, 15, 33, 42, 5, 14, 23, 32, 41, 4, 13];
        const whiteNodes = [0, 18, 36, 10, 19, 28, 20, 2, 11, 29, 38, 3, 12, 21, 30, 39, 31, 40];

        yellowNodes.forEach(id => state.board[id] = 'green');
        whiteNodes.forEach(id => state.board[id] = 'red');

        // Dinamik skor hesaplama
        state.score.red = Object.values(state.board).filter(v => v === 'red').length;
        state.score.green = Object.values(state.board).filter(v => v === 'green').length;

        render(); updateUI();
    }

    function getMoves(id, onlyCaps = false) {
        const list = [];
        const color = state.board[id];
        const enemy = color === 'red' ? 'green' : 'red';
        if(adj[id]) adj[id].forEach(to => {
            if(!state.board[to] && !onlyCaps) list.push({ to, cap: null });
            else if(state.board[to] === enemy) {
                const n1 = nodes[id], n2 = nodes[to];
                const tx = n2.x + (n2.x - n1.x), ty = n2.y + (n2.y - n1.y);
                const land = Object.values(nodes).find(x => Math.abs(x.x - tx) < 5 && Math.abs(x.y - ty) < 5);
                if(land && !state.board[land.id] && adj[to].includes(land.id)) list.push({ to: land.id, cap: to });
            }
        });
        return list;
    }

    function handleNodeClick(id) {
        if(state.gameOver || (state.mode === 'pve' && state.turn === 'green')) return;
        if(state.isCombo) {
            if(id === state.selected) { finishTurn(); return; }
            const move = getMoves(state.selected, true).find(m => m.to === id);
            if(move) performMove(state.selected, id, move.cap);
            return;
        }
        if(state.board[id] === state.turn) state.selected = id;
        else if(state.selected !== null && !state.board[id]) {
            const move = getMoves(state.selected).find(m => m.to === id);
            if(move) performMove(state.selected, id, move.cap);
        }
        render();
    }

    function performMove(from, to, capId) {
        state.board[to] = state.board[from]; state.board[from] = null;
        if(capId) {
            state.board[capId] = null;
            state.turn === 'red' ? state.score.green-- : state.score.red-- ;
            playSfx('capture');
            const nextCaps = getMoves(to, true);
            if(nextCaps.length > 0) {
                state.isCombo = true; state.selected = to;
                render(); updateUI();
                if(state.mode === 'pve' && state.turn === 'green') setTimeout(aiPlay, 800);
                return;
            }
        } else {
            playSfx('move');
        }
        finishTurn();
    }

    function finishTurn() {
        checkWinner(); if(state.gameOver) return;
        state.isCombo = false; state.selected = null;
        state.turn = (state.turn === 'red') ? 'green' : 'red';
        render(); updateUI();
        if(state.mode === 'pve' && state.turn === 'green') setTimeout(aiPlay, 800);
    }

    function aiPlay() {
        if (state.gameOver) return;

        const randomPick = arr => arr[Math.floor(Math.random() * arr.length)];

        /* â”€â”€ Tahta Ã¼zerinde Ã§alÄ±ÅŸan yardÄ±mcÄ±lar â”€â”€ */
        function movesOnBoard(board, id) {
            const list = [];
            const color = board[id];
            if (!color) return list;
            const enemy = color === 'red' ? 'green' : 'red';
            if (!adj[id]) return list;
            adj[id].forEach(to => {
                if (!board[to]) {
                    list.push({ from: id, to, cap: null });
                } else if (board[to] === enemy) {
                    const n1 = nodes[id], n2 = nodes[to];
                    const tx = n2.x + (n2.x - n1.x), ty = n2.y + (n2.y - n1.y);
                    const land = Object.values(nodes).find(x => Math.abs(x.x - tx) < 5 && Math.abs(x.y - ty) < 5);
                    if (land && !board[land.id] && adj[to].includes(land.id))
                        list.push({ from: id, to: land.id, cap: to });
                }
            });
            return list;
        }

        function allMovesOnBoard(board, color) {
            const list = [];
            for (const id in board)
                if (board[id] === color) movesOnBoard(board, +id).forEach(m => list.push(m));
            return list;
        }

        function applyMove(board, from, to, cap) {
            const b = Object.assign({}, board);
            b[to] = b[from]; b[from] = null;
            if (cap != null) b[cap] = null;
            return b;
        }

        function countPieces(board, color) {
            let n = 0;
            for (const k in board) if (board[k] === color) n++;
            return n;
        }

        /* Rakibin alabildiÄŸi taÅŸ sayÄ±sÄ±nÄ± dÃ¶ner (risk skoru) */
        function captureRisk(board, color) {
            const enemy = color === 'red' ? 'green' : 'red';
            const caps = allMovesOnBoard(board, enemy).filter(m => m.cap != null);
            return new Set(caps.map(m => m.cap)).size;
        }

        /* Pozisyon deÄŸerlendirme â€“ yeÅŸil perspektifinden */
        function evaluate(board) {
            const gc = countPieces(board, 'green');
            const rc = countPieces(board, 'red');
            if (rc === 0) return 9999;
            if (gc === 0) return -9999;
            let score = (gc - rc) * 100;
            score -= captureRisk(board, 'green') * 35;   // yeÅŸil tehlikede
            score += captureRisk(board, 'red')   * 35;   // kÄ±rmÄ±zÄ± tehlikede
            score += allMovesOnBoard(board, 'green').length * 2; // hareketlilik
            score -= allMovesOnBoard(board, 'red').length  * 2;
            return score;
        }

        /* Alpha-beta minimax â€“ kombo sÄ±rasÄ± aynÄ± oyuncuda kalÄ±r */
        function minimax(board, depth, alpha, beta, maximizing, comboId) {
            const gc = countPieces(board, 'green');
            const rc = countPieces(board, 'red');
            if (rc === 0) return 9999 + depth * 5;
            if (gc === 0) return -(9999 + depth * 5);
            if (depth === 0) return evaluate(board);

            let moves;
            if (comboId != null) {
                moves = movesOnBoard(board, comboId).filter(m => m.cap != null);
                if (moves.length === 0) {
                    // Kombo bitti, sÄ±ra deÄŸiÅŸti
                    return minimax(board, depth - 1, alpha, beta, !maximizing, null);
                }
            } else {
                const color = maximizing ? 'green' : 'red';
                moves = allMovesOnBoard(board, color);
                if (moves.length === 0) return maximizing ? -9999 : 9999;
                // Yakalamalar Ã¶nce (alpha-beta budama verimliliÄŸi artar)
                moves.sort((a, b) => (b.cap != null ? 1 : 0) - (a.cap != null ? 1 : 0));
            }

            if (maximizing) {
                let best = -Infinity;
                for (const m of moves) {
                    const nb = applyMove(board, m.from, m.to, m.cap);
                    // Yakalama varsa komboyu kontrol et
                    const nextCombo = (m.cap != null && movesOnBoard(nb, m.to).some(x => x.cap != null)) ? m.to : null;
                    const val = minimax(nb, depth - 1, alpha, beta, nextCombo != null ? true : false, nextCombo);
                    if (val > best) best = val;
                    alpha = Math.max(alpha, val);
                    if (beta <= alpha) break;
                }
                return best;
            } else {
                let best = Infinity;
                for (const m of moves) {
                    const nb = applyMove(board, m.from, m.to, m.cap);
                    const nextCombo = (m.cap != null && movesOnBoard(nb, m.to).some(x => x.cap != null)) ? m.to : null;
                    const val = minimax(nb, depth - 1, alpha, beta, nextCombo != null ? false : true, nextCombo);
                    if (val < best) best = val;
                    beta = Math.min(beta, val);
                    if (beta <= alpha) break;
                }
                return best;
            }
        }

        const board = Object.assign({}, state.board);

        /* â•â• KOLAY: tamamen rastgele â•â• */
        if (state.aiLevel === 'easy') {
            if (state.isCombo) {
                const caps = getMoves(state.selected, true);
                if (caps.length) performMove(state.selected, caps[0].to, caps[0].cap);
                else finishTurn();
                return;
            }
            const all = allMovesOnBoard(board, 'green');
            if (!all.length) { checkWinner(true); return; }
            const m = randomPick(all);
            performMove(m.from, m.to, m.cap);
            return;
        }

        /* â•â• ORTA: aÃ§gÃ¶zlÃ¼ + 1 adÄ±m savunma farkÄ±ndalÄ±ÄŸÄ± â•â• */
        if (state.aiLevel === 'medium') {
            if (state.isCombo) {
                const caps = getMoves(state.selected, true);
                if (caps.length) {
                    const scored = caps.map(m => {
                        const nb = applyMove(board, state.selected, m.to, m.cap);
                        return { m, s: countPieces(nb, 'green') - countPieces(nb, 'red') - captureRisk(nb, 'green') * 0.3 };
                    });
                    scored.sort((a, b) => b.s - a.s);
                    performMove(state.selected, scored[0].m.to, scored[0].m.cap);
                } else finishTurn();
                return;
            }
            const all = allMovesOnBoard(board, 'green');
            if (!all.length) { checkWinner(true); return; }
            const caps = all.filter(m => m.cap);
            const pool = caps.length ? caps : all;
            const scored = pool.map(m => {
                const nb = applyMove(board, m.from, m.to, m.cap);
                return { m, score: (countPieces(nb, 'green') - countPieces(nb, 'red')) * 10 - captureRisk(nb, 'green') * 4 };
            });
            scored.sort((a, b) => b.score - a.score);
            const best = scored[0].m;
            performMove(best.from, best.to, best.cap);
            return;
        }

        /* â•â• ZOR: minimax + alpha-beta, derinlik 5 â•â• */
        if (state.isCombo) {
            const caps = getMoves(state.selected, true);
            if (!caps.length) { finishTurn(); return; }
            let best = null, bestScore = -Infinity;
            for (const m of caps) {
                const nb = applyMove(board, state.selected, m.to, m.cap);
                const sc = minimax(nb, 4, -Infinity, Infinity, false, null);
                if (sc > bestScore) { bestScore = sc; best = m; }
            }
            performMove(state.selected, best.to, best.cap);
            return;
        }

        const all = allMovesOnBoard(board, 'green');
        if (!all.length) { checkWinner(true); return; }
        // Yakalamalar Ã¶nce â€“ alpha-beta daha verimli Ã§alÄ±ÅŸÄ±r
        const ordered = [...all.filter(m => m.cap), ...all.filter(m => !m.cap)];
        let best = null, bestScore = -Infinity;
        for (const m of ordered) {
            const nb = applyMove(board, m.from, m.to, m.cap);
            const nextCombo = (m.cap != null && movesOnBoard(nb, m.to).some(x => x.cap != null)) ? m.to : null;
            const sc = minimax(nb, 5, -Infinity, Infinity, false, nextCombo);
            if (sc > bestScore) { bestScore = sc; best = m; }
        }
        performMove(best.from, best.to, best.cap);
    }

    function updateUI() {
        const t = document.getElementById('turn-txt');
        const s = document.getElementById('status');
        const sc = document.getElementById('score');
        const cm = document.getElementById('combo-msg');
        if(!t || !s || !sc || !cm) return;
        
        t.innerText = state.turn === 'red' ? 'KÄ±rmÄ±zÄ±' : (state.mode === 'pvp' ? 'YeÅŸil' : 'Bilgisayar');
        s.style.background = state.turn === 'red' ? '#e53935' : '#4caf50';
        s.style.color = 'white';
        sc.innerText = `KÄ±rmÄ±zÄ±: ${state.score.red} | YeÅŸil: ${state.score.green}`;
        cm.style.display = state.isCombo ? 'block' : 'none';

        // Mini taÅŸ gÃ¶stergesi
        const ts = document.getElementById('turn-stone');
        if (ts) ts.className = 'turn-stone-dot ' + state.turn;

        // Tahta kenarÄ± parlamasÄ±
        const bc = document.getElementById('game-board-container');
        if (bc) {
            bc.classList.toggle('turn-red',   state.turn === 'red');
            bc.classList.toggle('turn-green', state.turn === 'green');
        }
    }

    function render() {
        nodesLayer.innerHTML = '';
        const moves = state.selected ? getMoves(state.selected, state.isCombo) : [];
        Object.values(nodes).forEach(n => {
            const pos = mapCoords(n.x, n.y);
            const px = pos.px, py = pos.py;
            
            // Sadece aktif noktalarda dot (nokta) Ã§izilir
            const pt = document.createElement('div');
            pt.className = 'node-point'; pt.style.left = px + '%'; pt.style.top = py + '%';
            nodesLayer.appendChild(pt);

            const hb = document.createElement('div');
            hb.className = 'node-hitbox'; hb.style.left = px + '%'; hb.style.top = py + '%';
            hb.onclick = () => handleNodeClick(n.id);
            nodesLayer.appendChild(hb);

            if(moves.some(m => m.to === n.id)) {
                const hint = document.createElement('div');
                hint.className = 'hint'; hint.style.left = px + '%'; hint.style.top = py + '%';
                nodesLayer.appendChild(hint);
            }
            if(state.board[n.id]) {
                const s = document.createElement('div');
                s.className = `stone ${state.board[n.id]} ${state.selected === n.id ? 'selected' : ''}`;
                s.style.left = px + '%'; s.style.top = py + '%';
                nodesLayer.appendChild(s);
            }
        });
    }

    function checkWinner(aiStuck = false) {
        let winColor = null;
        if (state.score.green === 0 || aiStuck) winColor = 'red';
        else if (state.score.red === 0) winColor = 'green';
        if (!winColor) return;

        state.gameOver = true;
        const t = document.getElementById('turn-txt');
        let headline, sub, cssClass, doFireworks = false;

        if (state.mode === 'pve') {
            if (winColor === 'red') {
                // Ä°nsan (kÄ±rmÄ±zÄ±) kazandÄ±
                headline = 'ğŸ† KAZANDINIZ!';
                sub = 'Tebrikler! BilgisayarÄ± yendiniz.';
                cssClass = 'red-win';
                doFireworks = true;
                setTimeout(() => playSfx('applause'), 600);
            } else {
                // AI kazandÄ±
                headline = 'ğŸ¤– BÄ°LGÄ°SAYAR KAZANDI';
                sub = 'Bu sefer bilgisayar daha iyiydi. Tekrar deneyin!';
                cssClass = 'ai-win';
            }
        } else {
            // Ä°ki kiÅŸili mod
            if (winColor === 'red') {
                headline = 'ğŸ”´ KIRMIZI OYUNCU KAZANDI!';
                sub = 'KÄ±rmÄ±zÄ± renkli oyuncuyu tebrik ederiz!';
                cssClass = 'red-win';
            } else {
                headline = 'ğŸŸ¢ YEÅÄ°L OYUNCU KAZANDI!';
                sub = 'YeÅŸil renkli oyuncuyu tebrik ederiz!';
                cssClass = 'green-win';
            }
            doFireworks = true;
        }

        if (t) t.innerText = headline;
        showWinnerModal(headline, sub, cssClass, doFireworks);
    }

    function showWinnerModal(headline, sub, cssClass, doFireworks) {
        const title = document.getElementById('winner-title');
        const subEl = document.getElementById('winner-sub');
        const trophy = document.getElementById('winner-trophy');
        if (title) { title.innerText = headline; title.className = 'winner-headline ' + cssClass; }
        if (subEl) subEl.innerText = sub;
        if (trophy) trophy.innerText = cssClass === 'ai-win' ? 'ğŸ¤–' : 'ğŸ†';
        if (winnerModal) winnerModal.classList.add('show');
        playSfx('win');
        if (doFireworks) startFireworks();
    }

    function hideWinnerModal() {
        if(winnerModal) winnerModal.classList.remove('show');
        stopFireworks();
    }

    function closeWinnerAndGoIntro() {
        hideWinnerModal();
        openIntroScreen();
    }

    /* â•â•â•â•â•â•â•â•â•â• HAVAÄ° FÄ°ÅEK MOTORU â•â•â•â•â•â•â•â•â•â• */
    let fwAnimId = null;

    function startFireworks() {
        const canvas = document.getElementById('fw-canvas');
        if (!canvas) return;
        canvas.width  = window.innerWidth;
        canvas.height = window.innerHeight;
        canvas.style.display = 'block';
        const ctx = canvas.getContext('2d');
        const particles = [];

        const COLORS = [
            '#ff4444','#ff9900','#ffee00','#44ff44',
            '#44aaff','#cc44ff','#ff44cc','#ffffff',
            '#ff6680','#00ffcc'
        ];

        function spawnBurst(x, y) {
            const count = 90 + Math.random() * 60;
            for (let i = 0; i < count; i++) {
                const angle = (Math.PI * 2 / count) * i + Math.random() * 0.3;
                const speed = 3 + Math.random() * 9;
                const color = COLORS[Math.floor(Math.random() * COLORS.length)];
                const size  = 2 + Math.random() * 4;
                particles.push({
                    x, y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    alpha: 1, color, size,
                    decay:   0.012 + Math.random() * 0.012,
                    gravity: 0.12  + Math.random() * 0.08,
                    trail: []
                });
            }
        }

        // Ä°lk patlamalar
        spawnBurst(canvas.width * 0.50, canvas.height * 0.35);
        spawnBurst(canvas.width * 0.25, canvas.height * 0.45);
        spawnBurst(canvas.width * 0.75, canvas.height * 0.40);

        let elapsed = 0;
        const launchTimes = [];
        for (let i = 0; i < 32; i++) {
            launchTimes.push(300 + i * 280 + Math.random() * 180);
        }
        let launchIdx = 0, lastTs = null;

        function frame(ts) {
            if (!lastTs) lastTs = ts;
            elapsed += ts - lastTs;
            lastTs = ts;

            while (launchIdx < launchTimes.length && elapsed >= launchTimes[launchIdx]) {
                spawnBurst(
                    canvas.width  * (0.12 + Math.random() * 0.76),
                    canvas.height * (0.08 + Math.random() * 0.52)
                );
                launchIdx++;
            }

            ctx.fillStyle = 'rgba(0,0,0,0.17)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.trail.push({ x: p.x, y: p.y, alpha: p.alpha });
                if (p.trail.length > 7) p.trail.shift();

                for (let j = 0; j < p.trail.length; j++) {
                    const t = p.trail[j];
                    ctx.beginPath();
                    ctx.arc(t.x, t.y, p.size * 0.45, 0, Math.PI * 2);
                    ctx.fillStyle = p.color + Math.floor(t.alpha * 70).toString(16).padStart(2,'0');
                    ctx.fill();
                }

                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fillStyle = p.color + Math.floor(p.alpha * 255).toString(16).padStart(2,'0');
                ctx.fill();

                p.x  += p.vx;
                p.y  += p.vy;
                p.vy += p.gravity;
                p.vx *= 0.98;
                p.alpha -= p.decay;
                if (p.alpha <= 0) particles.splice(i, 1);
            }

            if (elapsed < 10000 || particles.length > 0) {
                fwAnimId = requestAnimationFrame(frame);
            } else {
                stopFireworks();
            }
        }

        fwAnimId = requestAnimationFrame(frame);
    }

    function stopFireworks() {
        if (fwAnimId) { cancelAnimationFrame(fwAnimId); fwAnimId = null; }
        const canvas = document.getElementById('fw-canvas');
        if (canvas) {
            canvas.style.display = 'none';
            canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
        }
    }

    function toggleTheme() {
        const body = document.body;
        const btn = document.getElementById('themeBtn');
        const currentTheme = body.getAttribute('data-theme') || 'dark';
        const nextTheme = currentTheme === 'dark' ? 'light' : 'dark';
        body.setAttribute('data-theme', nextTheme);
        if(btn) btn.innerText = nextTheme === 'dark' ? 'â˜€ï¸ GÃœNDÃœZ MODU' : 'ğŸŒ™ GECE MODU';
    }

    let introMode = 'pve';
    let introDiff = 'medium';

    function selectIntroMode(mode) {
        introMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === mode));
        const wrap = document.getElementById('intro-diff-wrap');
        if (wrap) wrap.style.display = mode === 'pve' ? 'block' : 'none';
    }

    function selectIntroDiff(level) {
        introDiff = level;
        document.querySelectorAll('.diff-btn').forEach(b => b.classList.toggle('active', b.dataset.level === level));
    }

    function openIntroScreen() {
        // Buton durumlarÄ±nÄ± mevcut seÃ§imlere gÃ¶re sÄ±fÄ±rla
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.toggle('active', b.dataset.mode === introMode));
        document.querySelectorAll('.diff-btn').forEach(b => b.classList.toggle('active', b.dataset.level === introDiff));
        const wrap = document.getElementById('intro-diff-wrap');
        if (wrap) wrap.style.display = introMode === 'pve' ? 'block' : 'none';
        if (howToScreen) howToScreen.style.display = 'flex';
        switchToBgm('intro');
    }

    function closeHowToScreen() {
        if (howToScreen) howToScreen.style.display = 'none';
        hideWinnerModal();
        switchToBgm('game');
        initGame();
    }

    function openHowtoModal() {
        document.getElementById('howto-modal-bg').classList.add('show');
    }

    function closeHowtoModal(e) {
        if (!e || e.target === document.getElementById('howto-modal-bg')) {
            document.getElementById('howto-modal-bg').classList.remove('show');
        }
    }

    // Yatay mod kilidi
    function checkOrientation() {
        const isMobile = window.matchMedia('(max-width: 900px)').matches;
        const isLandscape = window.innerWidth > window.innerHeight;
        const lock = document.getElementById('landscape-lock');
        if (isMobile && isLandscape) {
            lock.classList.add('show');
        } else {
            lock.classList.remove('show');
        }
    }
    window.addEventListener('resize', checkOrientation);
    window.addEventListener('orientationchange', checkOrientation);
    checkOrientation();

    window.addEventListener('resize', () => {
        drawBoardLines();
        render();
    });

    document.body.setAttribute('data-theme', 'dark');
    setupAudio();
    buildGraph(); initGame();
</script>
</body>
</html>
